'use strict';

var _ = require('lodash');
var path = require('path');
var bluebird = require('bluebird');
var fs = bluebird.promisifyAll(require('fs-extra'));
var clean = require('./clean');
var requireDir = require('require-dir');
var plugins = requireDir('../plugins', { camelcase: true });
var cache = require('../utils/cache');
var config = require('../config');

module.exports = make;

function make(opts) {
  var task = process.env.task || 'make';

  if (opts && opts.targeted && opts.assets) {
    return run(opts.assets);
  }

  cache.clear();

  clean();

  cache.set('files', 'srcResolved', plugins.normalize(fs.walkSync(config.srcDir)));

  _(cache.get('deps')).filter({ role: 'asset' }).forEach(function (dep) {
    var asset = cache.get('files')[dep.srcResolved];
    if (!asset) {
      asset = plugins.normalize([dep.src])[0];
      cache.set('files', 'srcResolved', asset);
    }
    asset.role = 'asset';
    asset.isMinified = asset.isMinified || dep.isMinified;
  });

  // We should remove passive assets from the file cache by this point

  _(cache.get('files')).filter({ role: 'template' }).forEach(plugins.static);

  return run();

  function run(assets) {
    var transformAssets = runTransformAssets(assets || _.filter(cache.get('files'), { role: 'asset' }));

    return Promise.all(transformAssets).then(function () {
      var deps = _.filter(cache.get('deps'), function (dep) {
        return dep.role === 'asset';
      });
      if (assets) {
        (function () {
          var assetSources = _.map(assets, 'srcResolved');
          deps = deps.reduce(function (acc, dep) {
            if (assetSources.includes(dep.srcResolved)) {
              acc.push(dep);
            }
            return acc;
          }, []);
        })();
      }
      return Promise.all(_.castArray(runGenerateDeps(deps)));
    }).then(function (result) {
      return Promise.all(_.flatten(result));
    }).then(function () {
      return Promise.all(_.filter(assets || cache.get('files'), function (f) {
        return !f.role;
      }).map(function (asset) {
        var dest = path.join(config.destDir, asset.srcStripped);
        return fs.copyAsync(asset.src, dest);
      }));
    });
  }

  function runTransformAssets(assets) {
    return _(assets).flow(plugins.normalizeAsset, !_.get(opts, 'targeted')).flow(plugins.read).flow(plugins.transpile, function (a) {
      return !a.isMinified;
    }).flowTap(plugins.cacheImport, function (a) {
      return !a.isMinified;
    }).flow(plugins.copySource).flow(plugins.minify, function (a) {
      return !a.isMinified;
    }, task === 'build').flow(plugins.remapSources, function (a) {
      return a.map;
    }).value();
  }

  function runGenerateDeps(deps) {
    return _(deps).flow(plugins.normalizeDep).flow(plugins.getAssetContent).flowAll(plugins.concat, task === 'build').flow(plugins.outputSourcemaps).flow(plugins.output).value();
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXNrcy9tYWtlLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicGF0aCIsImJsdWViaXJkIiwiZnMiLCJwcm9taXNpZnlBbGwiLCJjbGVhbiIsInJlcXVpcmVEaXIiLCJwbHVnaW5zIiwiY2FtZWxjYXNlIiwiY2FjaGUiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIiwibWFrZSIsIm9wdHMiLCJ0YXNrIiwicHJvY2VzcyIsImVudiIsInRhcmdldGVkIiwiYXNzZXRzIiwicnVuIiwiY2xlYXIiLCJzZXQiLCJub3JtYWxpemUiLCJ3YWxrU3luYyIsInNyY0RpciIsImdldCIsImZpbHRlciIsInJvbGUiLCJmb3JFYWNoIiwiYXNzZXQiLCJkZXAiLCJzcmNSZXNvbHZlZCIsInNyYyIsImlzTWluaWZpZWQiLCJzdGF0aWMiLCJ0cmFuc2Zvcm1Bc3NldHMiLCJydW5UcmFuc2Zvcm1Bc3NldHMiLCJQcm9taXNlIiwiYWxsIiwidGhlbiIsImRlcHMiLCJhc3NldFNvdXJjZXMiLCJtYXAiLCJyZWR1Y2UiLCJhY2MiLCJpbmNsdWRlcyIsInB1c2giLCJjYXN0QXJyYXkiLCJydW5HZW5lcmF0ZURlcHMiLCJmbGF0dGVuIiwicmVzdWx0IiwiZiIsImRlc3QiLCJqb2luIiwiZGVzdERpciIsInNyY1N0cmlwcGVkIiwiY29weUFzeW5jIiwiZmxvdyIsIm5vcm1hbGl6ZUFzc2V0IiwicmVhZCIsInRyYW5zcGlsZSIsImEiLCJmbG93VGFwIiwiY2FjaGVJbXBvcnQiLCJjb3B5U291cmNlIiwibWluaWZ5IiwicmVtYXBTb3VyY2VzIiwidmFsdWUiLCJub3JtYWxpemVEZXAiLCJnZXRBc3NldENvbnRlbnQiLCJmbG93QWxsIiwiY29uY2F0Iiwib3V0cHV0U291cmNlbWFwcyIsIm91dHB1dCJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxJQUFJQyxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1DLE9BQU9ELFFBQVEsTUFBUixDQUFiO0FBQ0EsSUFBTUUs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QjtBQUFBLGFBQUssQ0FBQ0osRUFBRTVCLFVBQVI7QUFBQSxLQU5qQixFQU1xQ25CLFNBQVMsT0FOOUMsRUFPSjJDLElBUEksQ0FPQ25ELFFBQVE0RCxZQVBULEVBT3VCO0FBQUEsYUFBS0wsRUFBRW5CLEdBQVA7QUFBQSxLQVB2QixFQVFKeUIsS0FSSSxFQUFQO0FBU0Q7O0FBRUQsV0FBU25CLGVBQVQsQ0FBeUJSLElBQXpCLEVBQStCO0FBQzdCLFdBQU8xQyxFQUFFMEMsSUFBRixFQUNKaUIsSUFESSxDQUNDbkQsUUFBUThELFlBRFQsRUFFSlgsSUFGSSxDQUVDbkQsUUFBUStELGVBRlQsRUFHSkMsT0FISSxDQUdJaEUsUUFBUWlFLE1BSFosRUFHb0J6RCxTQUFTLE9BSDdCLEVBSUoyQyxJQUpJLENBSUNuRCxRQUFRa0UsZ0JBSlQsRUFLSmYsSUFMSSxDQUtDbkQsUUFBUW1FLE1BTFQsRUFNSk4sS0FOSSxFQUFQO0FBT0Q7QUFDRiIsImZpbGUiOiJtYWtlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmNvbnN0IGZzID0gYmx1ZWJpcmQucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ2ZzLWV4dHJhJykpO1xuY29uc3QgY2xlYW4gPSByZXF1aXJlKCcuL2NsZWFuJyk7XG5jb25zdCByZXF1aXJlRGlyID0gcmVxdWlyZSgncmVxdWlyZS1kaXInKTtcbmNvbnN0IHBsdWdpbnMgPSByZXF1aXJlRGlyKCcuLi9wbHVnaW5zJywge2NhbWVsY2FzZTogdHJ1ZX0pO1xuY29uc3QgY2FjaGUgPSByZXF1aXJlKCcuLi91dGlscy9jYWNoZScpO1xuY29uc3QgY29uZmlnID0gcmVxdWlyZSgnLi4vY29uZmlnJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gbWFrZTtcblxuZnVuY3Rpb24gbWFrZShvcHRzKSB7XG4gIGNvbnN0IHRhc2sgPSBwcm9jZXNzLmVudi50YXNrIHx8ICdtYWtlJztcblxuICBpZiAob3B0cyAmJiBvcHRzLnRhcmdldGVkICYmIG9wdHMuYXNzZXRzKSB7XG4gICAgcmV0dXJuIHJ1bihvcHRzLmFzc2V0cyk7XG4gIH1cblxuICBjYWNoZS5jbGVhcigpO1xuXG4gIGNsZWFuKCk7XG5cbiAgY2FjaGUuc2V0KCdmaWxlcycsICdzcmNSZXNvbHZlZCcsIHBsdWdpbnMubm9ybWFsaXplKGZzLndhbGtTeW5jKGNvbmZpZy5zcmNEaXIpKSk7XG5cbiAgXyhjYWNoZS5nZXQoJ2RlcHMnKSlcbiAgICAuZmlsdGVyKHtyb2xlOiAnYXNzZXQnfSlcbiAgICAuZm9yRWFjaChkZXAgPT4ge1xuICAgICAgbGV0IGFzc2V0ID0gY2FjaGUuZ2V0KCdmaWxlcycpW2RlcC5zcmNSZXNvbHZlZF07XG4gICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgIGFzc2V0ID0gcGx1Z2lucy5ub3JtYWxpemUoW2RlcC5zcmNdKVswXTtcbiAgICAgICAgY2FjaGUuc2V0KCdmaWxlcycsICdzcmNSZXNvbHZlZCcsIGFzc2V0KTtcbiAgICAgIH1cbiAgICAgIGFzc2V0LnJvbGUgPSAnYXNzZXQnO1xuICAgICAgYXNzZXQuaXNNaW5pZmllZCA9IGFzc2V0LmlzTWluaWZpZWQgfHwgZGVwLmlzTWluaWZpZWQ7XG4gICAgfSk7XG5cbiAgLy8gV2Ugc2hvdWxkIHJlbW92ZSBwYXNzaXZlIGFzc2V0cyBmcm9tIHRoZSBmaWxlIGNhY2hlIGJ5IHRoaXMgcG9pbnRcblxuICBfKGNhY2hlLmdldCgnZmlsZXMnKSkuZmlsdGVyKHtyb2xlOiAndGVtcGxhdGUnfSkuZm9yRWFjaChwbHVnaW5zLnN0YXRpYyk7XG5cblxuICByZXR1cm4gcnVuKCk7XG5cbiAgZnVuY3Rpb24gcnVuKGFzc2V0cykge1xuICAgIGNvbnN0IHRyYW5zZm9ybUFzc2V0cyA9IHJ1blRyYW5zZm9ybUFzc2V0cyhhc3NldHMgfHwgXy5maWx0ZXIoY2FjaGUuZ2V0KCdmaWxlcycpLCB7cm9sZTogJ2Fzc2V0J30pKTtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbCh0cmFuc2Zvcm1Bc3NldHMpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGxldCBkZXBzID0gXy5maWx0ZXIoY2FjaGUuZ2V0KCdkZXBzJyksIGRlcCA9PiBkZXAucm9sZSA9PT0gJ2Fzc2V0Jyk7XG4gICAgICAgIGlmIChhc3NldHMpIHtcbiAgICAgICAgICBjb25zdCBhc3NldFNvdXJjZXMgPSBfLm1hcChhc3NldHMsICdzcmNSZXNvbHZlZCcpO1xuICAgICAgICAgIGRlcHMgPSBkZXBzLnJlZHVjZSgoYWNjLCBkZXApID0+IHtcbiAgICAgICAgICAgIGlmIChhc3NldFNvdXJjZXMuaW5jbHVkZXMoZGVwLnNyY1Jlc29sdmVkKSkge1xuICAgICAgICAgICAgICBhY2MucHVzaChkZXApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICB9LCBbXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKF8uY2FzdEFycmF5KHJ1bkdlbmVyYXRlRGVwcyhkZXBzKSkpXG4gICAgICB9KVxuICAgICAgLnRoZW4ocmVzdWx0ID0+IFByb21pc2UuYWxsKF8uZmxhdHRlbihyZXN1bHQpKSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKF8uZmlsdGVyKGFzc2V0cyB8fCBjYWNoZS5nZXQoJ2ZpbGVzJyksIGYgPT4gIWYucm9sZSkubWFwKGFzc2V0ID0+IHtcbiAgICAgICAgICBjb25zdCBkZXN0ID0gcGF0aC5qb2luKGNvbmZpZy5kZXN0RGlyLCBhc3NldC5zcmNTdHJpcHBlZCk7XG4gICAgICAgICAgcmV0dXJuIGZzLmNvcHlBc3luYyhhc3NldC5zcmMsIGRlc3QpO1xuICAgICAgICB9KSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJ1blRyYW5zZm9ybUFzc2V0cyhhc3NldHMpIHtcbiAgICByZXR1cm4gXyhhc3NldHMpXG4gICAgICAuZmxvdyhwbHVnaW5zLm5vcm1hbGl6ZUFzc2V0LCAhXy5nZXQob3B0cywgJ3RhcmdldGVkJykpXG4gICAgICAuZmxvdyhwbHVnaW5zLnJlYWQpXG4gICAgICAuZmxvdyhwbHVnaW5zLnRyYW5zcGlsZSwgYSA9PiAhYS5pc01pbmlmaWVkKVxuICAgICAgLmZsb3dUYXAocGx1Z2lucy5jYWNoZUltcG9ydCwgYSA9PiAhYS5pc01pbmlmaWVkKVxuICAgICAgLmZsb3cocGx1Z2lucy5jb3B5U291cmNlKVxuICAgICAgLmZsb3cocGx1Z2lucy5taW5pZnksIGEgPT4gIWEuaXNNaW5pZmllZCwgdGFzayA9PT0gJ2J1aWxkJylcbiAgICAgIC5mbG93KHBsdWdpbnMucmVtYXBTb3VyY2VzLCBhID0+IGEubWFwKVxuICAgICAgLnZhbHVlKCk7XG4gIH1cblxuICBmdW5jdGlvbiBydW5HZW5lcmF0ZURlcHMoZGVwcykge1xuICAgIHJldHVybiBfKGRlcHMpXG4gICAgICAuZmxvdyhwbHVnaW5zLm5vcm1hbGl6ZURlcClcbiAgICAgIC5mbG93KHBsdWdpbnMuZ2V0QXNzZXRDb250ZW50KVxuICAgICAgLmZsb3dBbGwocGx1Z2lucy5jb25jYXQsIHRhc2sgPT09ICdidWlsZCcpXG4gICAgICAuZmxvdyhwbHVnaW5zLm91dHB1dFNvdXJjZW1hcHMpXG4gICAgICAuZmxvdyhwbHVnaW5zLm91dHB1dClcbiAgICAgIC52YWx1ZSgpO1xuICB9XG59XG4iXX0=
'use strict';

var _ = require('lodash');
var path = require('path');
var bluebird = require('bluebird');
var fs = bluebird.promisifyAll(require('fs-extra'));
var clean = require('./clean');
var requireDir = require('require-dir');
var plugins = requireDir('../plugins', { camelcase: true });
var cache = require('../utils/cache');
var config = require('../config');

module.exports = make;

function make(opts) {
  var task = process.env.task || 'make';

  if (opts && opts.targeted && opts.assets) {
    return run(opts.assets);
  }

  cache.clear();

  clean();

  cache.set('files', 'srcResolved', plugins.normalize(fs.walkSync(config.srcDir)));

  _(cache.get('deps')).filter({ role: 'asset' }).forEach(function (dep) {
    var asset = cache.get('files')[dep.srcResolved];
    if (!asset) {
      asset = plugins.normalize([dep.src])[0];
      cache.set('files', 'srcResolved', asset);
    }
    asset.role = 'asset';
    asset.isMinified = asset.isMinified || dep.isMinified;
  });

  // We should remove passive assets from the file cache by this point

  _(cache.get('files')).filter({ role: 'template' }).forEach(plugins.static);

  return run();

  function run(assets) {
    var transformAssets = runTransformAssets(assets || _.filter(cache.get('files'), { role: 'asset' }));

    return Promise.all(transformAssets).then(function () {
      var deps = _.filter(cache.get('deps'), function (dep) {
        return dep.role === 'asset';
      });
      if (assets) {
        (function () {
          var assetSources = _.map(assets, 'srcResolved');
          deps = deps.reduce(function (acc, dep) {
            if (_.includes(assetSources, dep.srcResolved)) {
              acc.push(dep);
            }
            return acc;
          }, []);
        })();
      }
      return Promise.all(_.castArray(runGenerateDeps(deps)));
    }).then(function (result) {
      return Promise.all(_.flatten(result));
    }).then(function () {
      return Promise.all(_.filter(assets || cache.get('files'), function (f) {
        return !f.role;
      }).map(function (asset) {
        var dest = path.join(config.destDir, asset.srcStripped);
        return fs.copyAsync(asset.src, dest);
      }));
    });
  }

  function runTransformAssets(assets) {
    return _(assets).flow(plugins.normalizeAsset, !_.get(opts, 'targeted')).flow(plugins.read).flow(plugins.transpile, function (a) {
      return !a.isMinified;
    }).flowTap(plugins.cacheImport, function (a) {
      return !a.isMinified;
    }).flow(plugins.copySource).flow(plugins.minify, function (a) {
      return !a.isMinified;
    }, task === 'build').flow(plugins.remapSources, function (a) {
      return a.map;
    }).value();
  }

  function runGenerateDeps(deps) {
    return _(deps).flow(plugins.normalizeDep).flow(plugins.getAssetContent).flowLog().flowAll(plugins.concat, task === 'build').flow(plugins.outputSourcemaps).flow(plugins.output).value();
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXNrcy9tYWtlLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicGF0aCIsImJsdWViaXJkIiwiZnMiLCJwcm9taXNpZnlBbGwiLCJjbGVhbiIsInJlcXVpcmVEaXIiLCJwbHVnaW5zIiwiY2FtZWxjYXNlIiwiY2FjaGUiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIiwibWFrZSIsIm9wdHMiLCJ0YXNrIiwicHJvY2VzcyIsImVudiIsInRhcmdldGVkIiwiYXNzZXRzIiwicnVuIiwiY2xlYXIiLCJzZXQiLCJub3JtYWxpemUiLCJ3YWxrU3luYyIsInNyY0RpciIsImdldCIsImZpbHRlciIsInJvbGUiLCJmb3JFYWNoIiwiYXNzZXQiLCJkZXAiLCJzcmNSZXNvbHZlZCIsInNyYyIsImlzTWluaWZpZWQiLCJzdGF0aWMiLCJ0cmFuc2Zvcm1Bc3NldHMiLCJydW5UcmFuc2Zvcm1Bc3NldHMiLCJQcm9taXNlIiwiYWxsIiwidGhlbiIsImRlcHMiLCJhc3NldFNvdXJjZXMiLCJtYXAiLCJyZWR1Y2UiLCJhY2MiLCJpbmNsdWRlcyIsInB1c2giLCJjYXN0QXJyYXkiLCJydW5HZW5lcmF0ZURlcHMiLCJmbGF0dGVuIiwicmVzdWx0IiwiZiIsImRlc3QiLCJqb2luIiwiZGVzdERpciIsInNyY1N0cmlwcGVkIiwiY29weUFzeW5jIiwiZmxvdyIsIm5vcm1hbGl6ZUFzc2V0IiwicmVhZCIsInRyYW5zcGlsZSIsImEiLCJmbG93VGFwIiwiY2FjaGVJbXBvcnQiLCJjb3B5U291cmNlIiwibWluaWZ5IiwicmVtYXBTb3VyY2VzIiwidmFsdWUiLCJub3JtYWxpemVEZXAiLCJnZXRBc3NldENvbnRlbnQiLCJmbG93TG9nIiwiZmxvd0FsbCIsImNvbmNhdCIsIm91dHB1dFNvdXJjZW1hcHMiLCJvdXRwdXQiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsSUFBSUMsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNQyxPQUFPRCxRQUFRLE1BQVIsQ0FBYjtB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Q0FNQ25ELFFBQVEyRCxNQU5ULEVBTWlCO0FBQUEsYUFBSyxDQUFDSixFQUFFNUIsVUFBUjtBQUFBLEtBTmpCLEVBTXFDbkIsU0FBUyxPQU45QyxFQU9KMkMsSUFQSSxDQU9DbkQsUUFBUTRELFlBUFQsRUFPdUI7QUFBQSxhQUFLTCxFQUFFbkIsR0FBUDtBQUFBLEtBUHZCLEVBUUp5QixLQVJJLEVBQVA7QUFTRDs7QUFFRCxXQUFTbkIsZUFBVCxDQUF5QlIsSUFBekIsRUFBK0I7QUFDN0IsV0FBTzFDLEVBQUUwQyxJQUFGLEVBQ0ppQixJQURJLENBQ0NuRCxRQUFROEQsWUFEVCxFQUVKWCxJQUZJLENBRUNuRCxRQUFRK0QsZUFGVCxFQUdKQyxPQUhJLEdBSUpDLE9BSkksQ0FJSWpFLFFBQVFrRSxNQUpaLEVBSW9CMUQsU0FBUyxPQUo3QixFQUtKMkMsSUFMSSxDQUtDbkQsUUFBUW1FLGdCQUxULEVBTUpoQixJQU5JLENBTUNuRCxRQUFRb0UsTUFOVCxFQU9KUCxLQVBJLEVBQVA7QUFRRDtBQUNGIiwiZmlsZSI6Im1ha2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgYmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuY29uc3QgZnMgPSBibHVlYmlyZC5wcm9taXNpZnlBbGwocmVxdWlyZSgnZnMtZXh0cmEnKSk7XG5jb25zdCBjbGVhbiA9IHJlcXVpcmUoJy4vY2xlYW4nKTtcbmNvbnN0IHJlcXVpcmVEaXIgPSByZXF1aXJlKCdyZXF1aXJlLWRpcicpO1xuY29uc3QgcGx1Z2lucyA9IHJlcXVpcmVEaXIoJy4uL3BsdWdpbnMnLCB7Y2FtZWxjYXNlOiB0cnVlfSk7XG5jb25zdCBjYWNoZSA9IHJlcXVpcmUoJy4uL3V0aWxzL2NhY2hlJyk7XG5jb25zdCBjb25maWcgPSByZXF1aXJlKCcuLi9jb25maWcnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBtYWtlO1xuXG5mdW5jdGlvbiBtYWtlKG9wdHMpIHtcbiAgY29uc3QgdGFzayA9IHByb2Nlc3MuZW52LnRhc2sgfHwgJ21ha2UnO1xuXG4gIGlmIChvcHRzICYmIG9wdHMudGFyZ2V0ZWQgJiYgb3B0cy5hc3NldHMpIHtcbiAgICByZXR1cm4gcnVuKG9wdHMuYXNzZXRzKTtcbiAgfVxuXG4gIGNhY2hlLmNsZWFyKCk7XG5cbiAgY2xlYW4oKTtcblxuICBjYWNoZS5zZXQoJ2ZpbGVzJywgJ3NyY1Jlc29sdmVkJywgcGx1Z2lucy5ub3JtYWxpemUoZnMud2Fsa1N5bmMoY29uZmlnLnNyY0RpcikpKTtcblxuICBfKGNhY2hlLmdldCgnZGVwcycpKVxuICAgIC5maWx0ZXIoe3JvbGU6ICdhc3NldCd9KVxuICAgIC5mb3JFYWNoKGRlcCA9PiB7XG4gICAgICBsZXQgYXNzZXQgPSBjYWNoZS5nZXQoJ2ZpbGVzJylbZGVwLnNyY1Jlc29sdmVkXTtcbiAgICAgIGlmICghYXNzZXQpIHtcbiAgICAgICAgYXNzZXQgPSBwbHVnaW5zLm5vcm1hbGl6ZShbZGVwLnNyY10pWzBdO1xuICAgICAgICBjYWNoZS5zZXQoJ2ZpbGVzJywgJ3NyY1Jlc29sdmVkJywgYXNzZXQpO1xuICAgICAgfVxuICAgICAgYXNzZXQucm9sZSA9ICdhc3NldCc7XG4gICAgICBhc3NldC5pc01pbmlmaWVkID0gYXNzZXQuaXNNaW5pZmllZCB8fCBkZXAuaXNNaW5pZmllZDtcbiAgICB9KTtcblxuICAvLyBXZSBzaG91bGQgcmVtb3ZlIHBhc3NpdmUgYXNzZXRzIGZyb20gdGhlIGZpbGUgY2FjaGUgYnkgdGhpcyBwb2ludFxuXG4gIF8oY2FjaGUuZ2V0KCdmaWxlcycpKS5maWx0ZXIoe3JvbGU6ICd0ZW1wbGF0ZSd9KS5mb3JFYWNoKHBsdWdpbnMuc3RhdGljKTtcblxuXG4gIHJldHVybiBydW4oKTtcblxuICBmdW5jdGlvbiBydW4oYXNzZXRzKSB7XG4gICAgY29uc3QgdHJhbnNmb3JtQXNzZXRzID0gcnVuVHJhbnNmb3JtQXNzZXRzKGFzc2V0cyB8fCBfLmZpbHRlcihjYWNoZS5nZXQoJ2ZpbGVzJyksIHtyb2xlOiAnYXNzZXQnfSkpO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHRyYW5zZm9ybUFzc2V0cylcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IGRlcHMgPSBfLmZpbHRlcihjYWNoZS5nZXQoJ2RlcHMnKSwgZGVwID0+IGRlcC5yb2xlID09PSAnYXNzZXQnKTtcbiAgICAgICAgaWYgKGFzc2V0cykge1xuICAgICAgICAgIGNvbnN0IGFzc2V0U291cmNlcyA9IF8ubWFwKGFzc2V0cywgJ3NyY1Jlc29sdmVkJyk7XG4gICAgICAgICAgZGVwcyA9IGRlcHMucmVkdWNlKChhY2MsIGRlcCkgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaW5jbHVkZXMoYXNzZXRTb3VyY2VzLCBkZXAuc3JjUmVzb2x2ZWQpKSB7XG4gICAgICAgICAgICAgIGFjYy5wdXNoKGRlcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgIH0sIFtdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXy5jYXN0QXJyYXkocnVuR2VuZXJhdGVEZXBzKGRlcHMpKSlcbiAgICAgIH0pXG4gICAgICAudGhlbihyZXN1bHQgPT4gUHJvbWlzZS5hbGwoXy5mbGF0dGVuKHJlc3VsdCkpKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXy5maWx0ZXIoYXNzZXRzIHx8IGNhY2hlLmdldCgnZmlsZXMnKSwgZiA9PiAhZi5yb2xlKS5tYXAoYXNzZXQgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlc3QgPSBwYXRoLmpvaW4oY29uZmlnLmRlc3REaXIsIGFzc2V0LnNyY1N0cmlwcGVkKTtcbiAgICAgICAgICByZXR1cm4gZnMuY29weUFzeW5jKGFzc2V0LnNyYywgZGVzdCk7XG4gICAgICAgIH0pKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcnVuVHJhbnNmb3JtQXNzZXRzKGFzc2V0cykge1xuICAgIHJldHVybiBfKGFzc2V0cylcbiAgICAgIC5mbG93KHBsdWdpbnMubm9ybWFsaXplQXNzZXQsICFfLmdldChvcHRzLCAndGFyZ2V0ZWQnKSlcbiAgICAgIC5mbG93KHBsdWdpbnMucmVhZClcbiAgICAgIC5mbG93KHBsdWdpbnMudHJhbnNwaWxlLCBhID0+ICFhLmlzTWluaWZpZWQpXG4gICAgICAuZmxvd1RhcChwbHVnaW5zLmNhY2hlSW1wb3J0LCBhID0+ICFhLmlzTWluaWZpZWQpXG4gICAgICAuZmxvdyhwbHVnaW5zLmNvcHlTb3VyY2UpXG4gICAgICAuZmxvdyhwbHVnaW5zLm1pbmlmeSwgYSA9PiAhYS5pc01pbmlmaWVkLCB0YXNrID09PSAnYnVpbGQnKVxuICAgICAgLmZsb3cocGx1Z2lucy5yZW1hcFNvdXJjZXMsIGEgPT4gYS5tYXApXG4gICAgICAudmFsdWUoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJ1bkdlbmVyYXRlRGVwcyhkZXBzKSB7XG4gICAgcmV0dXJuIF8oZGVwcylcbiAgICAgIC5mbG93KHBsdWdpbnMubm9ybWFsaXplRGVwKVxuICAgICAgLmZsb3cocGx1Z2lucy5nZXRBc3NldENvbnRlbnQpXG4gICAgICAuZmxvd0xvZygpXG4gICAgICAuZmxvd0FsbChwbHVnaW5zLmNvbmNhdCwgdGFzayA9PT0gJ2J1aWxkJylcbiAgICAgIC5mbG93KHBsdWdpbnMub3V0cHV0U291cmNlbWFwcylcbiAgICAgIC5mbG93KHBsdWdpbnMub3V0cHV0KVxuICAgICAgLnZhbHVlKCk7XG4gIH1cbn1cbiJdfQ==
'use strict';

var _ = require('lodash');
var postcss = require('postcss');
var cssnano = require('cssnano');
var uglifyjs = require('uglify-js');

module.exports = function minify(file) {
  var minified = minifiers[file.typeDest](file);
  return minified.then(function (result) {
    return _.assign(file, result);
  });
};

var minifiers = { css: css, js: js };

function css(file) {
  var opts = {
    from: file.src,
    to: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  };

  return postcss([cssnano()]).process(file.content, opts).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}

function js(file) {
  var opts = {
    fromString: true,
    sourceMapUrl: false
  };

  if (file.map) {
    opts.inSourceMap = _.isObject(file.map) ? file.map : JSON.parse(file.map);
    opts.outSourceMap = file.destFilename + '.map';
  }

  var result = uglifyjs.minify(file.content, opts);

  return Promise.resolve({ content: result.code, map: result.map });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL21pbmlmeS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsInBvc3Rjc3MiLCJjc3NuYW5vIiwidWdsaWZ5anMiLCJtb2R1bGUiLCJleHBvcnRzIiwibWluaWZ5IiwiZmlsZSIsIm1pbmlmaWVkIiwibWluaWZpZXJzIiwidHlwZURlc3QiLCJ0aGVuIiwiYXNzaWduIiwicmVzdWx0IiwiY3NzIiwianMiLCJvcHRzIiwiZnJvbSIsInNyYyIsInRvIiwibWFwIiwicHJldiIsImlubGluZSIsInNvdXJjZXNDb250ZW50IiwiYW5ub3RhdGlvbiIsInByb2Nlc3MiLCJjb250ZW50IiwidG9TdHJpbmciLCJmcm9tU3RyaW5nIiwic291cmNlTWFwVXJsIiwiaW5Tb3VyY2VNYXAiLCJpc09iamVjdCIsIkpTT04iLCJwYXJzZSIsIm91dFNvdXJjZU1hcCIsImRlc3RGaWxlbmFtZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29kZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxJQUFJQyxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1DLFVBQVVELFFBQVEsU0FBUixDQUFoQjtBQUNBLElBQU1FLFVBQVVGLFFBQVEsU0FBUixDQUFoQjtBQUNBLElBQU1HLFdBQVdILFFBQVEsV0FBUixDQUFqQjs7QUFFQUksT0FBT0MsT0FBUCxHQUFpQixTQUFTQyxNQUFULENBQWdCQyxJQUFoQixFQUFzQjtBQUNyQyxNQUFNQyxXQUFXQyxVQUFVRixLQUFLRyxRQUFmLEVBQXlCSCxJQUF6QixDQUFqQjtBQUNBLFNBQU9DLFNBQVNHLElBQVQsQ0FBYztBQUFBLFdBQVVaLEVBQUVhLE1BQUYsQ0FBU0wsSUFBVCxFQUFlTSxNQUFmLENBQVY7QUFBQSxHQUFkLENBQVA7QUFDRCxDQUhEOztBQUtBLElBQU1KLFlBQVksRUFBQ0ssUUFBRCxFQUFNQyxNQUFOLEVBQWxCOztBQUVBLFNBQVNELEdBQVQsQ0FBYVAsSUFBYixFQUFtQjtBQUNqQixNQUFNUyxPQUFPO0FBQ1hDLFVBQU1WLEtBQUtXLEdBREE7QUFFWEMsUUFBSVosS0FBS1csR0FGRTtBQUdYRSxTQUFLO0FBQ0hDLFlBQU1kLEtBQUthLEdBRFI7QUFFSEUsY0FBUSxLQUZMO0FBR0hDLHNCQUFnQixLQUhiO0FBSUhDLGtCQUFZO0FBSlQ7QUFITSxHQUFiOztBQVdBLFNBQU92QixRQUFRLENBQUNDLFNBQUQsQ0FBUixFQUNKdUIsT0FESSxDQUNJbEIsS0FBS21CLE9BRFQsRUFDa0JWLElBRGxCLEVBRUpMLElBRkksQ0FFQztBQUFBLFdBQVc7QUFDZmUsZUFBU2IsT0FBT0MsR0FERDtBQUVmTSxXQUFLUCxPQUFPTyxHQUFQLENBQVdPLFFBQVg7QUFGVSxLQUFYO0FBQUEsR0FGRCxDQUFQO0FBTUQ7O0FBRUQsU0FBU1osRUFBVCxDQUFZUixJQUFaLEVBQWtCO0FBQ2hCLE1BQU1TLE9BQU87QUFDWFksZ0JBQVksSUFERDtBQUVYQyxrQkFBYztBQUZILEdBQWI7O0FBS0EsTUFBSXRCLEtBQUthLEdBQVQsRUFBYztBQUNaSixTQUFLYyxXQUFMLEdBQW1CL0IsRUFBRWdDLFFBQUYsQ0FBV3hCLEtBQUthLEdBQWhCLElBQXVCYixLQUFLYSxHQUE1QixHQUFrQ1ksS0FBS0MsS0FBTCxDQUFXMUIsS0FBS2EsR0FBaEIsQ0FBckQ7QUFDQUosU0FBS2tCLFlBQUwsR0FBb0IzQixLQUFLNEIsWUFBTCxHQUFvQixNQUF4QztBQUNEOztBQUVELE1BQU10QixTQUFTVixTQUFTRyxNQUFULENBQWdCQyxLQUFLbUIsT0FBckIsRUFBOEJWLElBQTlCLENBQWY7O0FBRUEsU0FBT29CLFFBQVFDLE9BQVIsQ0FBZ0IsRUFBQ1gsU0FBU2IsT0FBT3lCLElBQWpCLEVBQXVCbEIsS0FBS1AsT0FBT08sR0FBbkMsRUFBaEIsQ0FBUDtBQUNEIiwiZmlsZSI6Im1pbmlmeS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHBvc3Rjc3MgPSByZXF1aXJlKCdwb3N0Y3NzJyk7XG5jb25zdCBjc3NuYW5vID0gcmVxdWlyZSgnY3NzbmFubycpO1xuY29uc3QgdWdsaWZ5anMgPSByZXF1aXJlKCd1Z2xpZnktanMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBtaW5pZnkoZmlsZSkge1xuICBjb25zdCBtaW5pZmllZCA9IG1pbmlmaWVyc1tmaWxlLnR5cGVEZXN0XShmaWxlKTtcbiAgcmV0dXJuIG1pbmlmaWVkLnRoZW4ocmVzdWx0ID0+IF8uYXNzaWduKGZpbGUsIHJlc3VsdCkpO1xufVxuXG5jb25zdCBtaW5pZmllcnMgPSB7Y3NzLCBqc307XG5cbmZ1bmN0aW9uIGNzcyhmaWxlKSB7XG4gIGNvbnN0IG9wdHMgPSB7XG4gICAgZnJvbTogZmlsZS5zcmMsXG4gICAgdG86IGZpbGUuc3JjLFxuICAgIG1hcDoge1xuICAgICAgcHJldjogZmlsZS5tYXAsXG4gICAgICBpbmxpbmU6IGZhbHNlLFxuICAgICAgc291cmNlc0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgYW5ub3RhdGlvbjogZmFsc2VcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIHBvc3Rjc3MoW2Nzc25hbm8oKV0pXG4gICAgLnByb2Nlc3MoZmlsZS5jb250ZW50LCBvcHRzKVxuICAgIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgICAgY29udGVudDogcmVzdWx0LmNzcyxcbiAgICAgIG1hcDogcmVzdWx0Lm1hcC50b1N0cmluZygpXG4gICAgfSkpO1xufVxuXG5mdW5jdGlvbiBqcyhmaWxlKSB7XG4gIGNvbnN0IG9wdHMgPSB7XG4gICAgZnJvbVN0cmluZzogdHJ1ZSxcbiAgICBzb3VyY2VNYXBVcmw6IGZhbHNlXG4gIH07XG5cbiAgaWYgKGZpbGUubWFwKSB7XG4gICAgb3B0cy5pblNvdXJjZU1hcCA9IF8uaXNPYmplY3QoZmlsZS5tYXApID8gZmlsZS5tYXAgOiBKU09OLnBhcnNlKGZpbGUubWFwKTtcbiAgICBvcHRzLm91dFNvdXJjZU1hcCA9IGZpbGUuZGVzdEZpbGVuYW1lICsgJy5tYXAnO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gdWdsaWZ5anMubWluaWZ5KGZpbGUuY29udGVudCwgb3B0cyk7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7Y29udGVudDogcmVzdWx0LmNvZGUsIG1hcDogcmVzdWx0Lm1hcH0pO1xufVxuIl19
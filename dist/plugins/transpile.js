'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');

var _require = require('rollup'),
    rollup = _require.rollup;

var rollupBabel = require('rollup-plugin-babel');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');
var config = require('../config');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  var babelOpts = {
    filename: file.base,
    presets: [['babel-preset-es2015', { modules: false }], 'babel-preset-es2016', 'babel-preset-es2017', 'babel-preset-react'],
    plugins: ['babel-plugin-external-helpers'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };

  var rollupOpts = {
    entry: file.src,
    plugins: [rollupBabel(babelOpts)]
  };

  var output = rollup(rollupOpts).then(function (bundle) {
    var temp = bundle.generate({
      format: 'es',
      sourceMap: true,
      sourceMapFile: config.srcDir
    });
    var result = {
      content: temp.code,
      map: temp.map,
      mapImports: temp.map.sources
    };
    return result;
  }).catch(function (result) {
    console.log(result);
  });

  return output;

  /*
  const transformed = babel.transform(file.content, opts);
  const result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
  */
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicm9sbHVwIiwicm9sbHVwQmFiZWwiLCJwb3N0Y3NzIiwiY3NzbmV4dCIsImNvbmZpZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0cmFuc3BpbGUiLCJmaWxlIiwidHJhbnNwaWxlZCIsInRyYW5zcGlsZXJzIiwidHlwZSIsInRoZW4iLCJhc3NpZ24iLCJyZXN1bHQiLCJzYXNzIiwibGVzcyIsInN0eWx1cyIsImNvZmZlZSIsImpzIiwiY3NzIiwicHJvbWlzaWZ5IiwicmVuZGVyIiwiZGF0YSIsImNvbnRlbnQiLCJzcmMiLCJpbmNsdWRlUGF0aHMiLCJkaXIiLCJzb3VyY2VNYXAiLCJvdXRGaWxlIiwibmFtZSIsIm9taXRTb3VyY2VNYXBVcmwiLCJ0b1N0cmluZyIsIm1hcCIsIm1hcEltcG9ydHMiLCJzdGF0cyIsImluY2x1ZGVkRmlsZXMiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJpbmNsdWRlZCIsImZpbGVuYW1lIiwicGF0aHMiLCJpbXBvcnRzIiwic3R5bGUiLCJzZXQiLCJjb21tZW50IiwiZGVmaW5lIiwicmVzb2x2ZXIiLCJlcnIiLCJzb3VyY2VtYXAiLCJkZXBzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJvcHRzIiwic291cmNlRmlsZXMiLCJjb21waWxlZCIsImNvbXBpbGUiLCJ2M1NvdXJjZU1hcCIsImJhYmVsT3B0cyIsImJhc2UiLCJwcmVzZXRzIiwibW9kdWxlcyIsInBsdWdpbnMiLCJzb3VyY2VNYXBzIiwic291cmNlRmlsZU5hbWUiLCJhc3QiLCJjb21wYWN0Iiwicm9sbHVwT3B0cyIsImVudHJ5Iiwib3V0cHV0IiwidGVtcCIsImJ1bmRsZSIsImdlbmVyYXRlIiwiZm9ybWF0Iiwic291cmNlTWFwRmlsZSIsInNyY0RpciIsImNvZGUiLCJzb3VyY2VzIiwiY2F0Y2giLCJjb25zb2xlIiwibG9nIiwiZnJvbSIsInByZXYiLCJpbmxpbmUiLCJzb3VyY2VzQ29udGVudCIsImFubm90YXRpb24iXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNQyxJQUFJRCxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1FLFdBQVdGLFFBQVEsVUFBUixDQUFqQjtBQUNBLElBQU1HLFFBQVFILFFBQVEsV0FBUixDQUFkO0FBQ0EsSUFBTUksUUFBUUosUUFBUSxNQUFSLENBQWQ7QUFDQSxJQUFNSyxVQUFVTCxRQUFRLFFBQVIsQ0FBaEI7QUFDQSxJQUFNTSxVQUFVTixRQUFRLGVBQVIsQ0FBaEI7QUFDQSxJQUFNTyxRQUFRUCxRQUFRLFlBQVIsQ0FBZDs7ZUFDaUJBLFFBQVEsUUFBUixDO0lBQVZRLE0sWUFBQUEsTTs7QUFDUCxJQUFNQyxjQUFjVCxRQUFRLHFCQUFSLENBQXBCO0FBQ0EsSUFBTVUsVUFBVVYsUUFBUSxTQUFSLENBQWhCO0FBQ0EsSUFBTVcsVUFBVVgsUUFBUSxpQkFBUixDQUFoQjtBQUNBLElBQU1ZLFNBQVNaLFFBQVEsV0FBUixDQUFmOztBQUVBYSxPQUFPQyxPQUFQLEdBQWlCLFNBQVNDLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCO0FBQ3hDLE1BQU1DLGFBQWFDLFlBQVlGLEtBQUtHLElBQWpCLEVBQXVCSCxJQUF2QixDQUFuQjtBQUNBLFNBQU9DLFdBQVdHLElBQVgsQ0FBZ0I7QUFBQSxXQUFVbkIsRUFBRW9CLE1BQUYsQ0FBU0wsSUFBVCxFQUFlTSxNQUFmLENBQVY7QUFBQSxHQUFoQixDQUFQO0FBQ0QsQ0FIRDs7QUFLQSxJQUFNSixjQUFjLEVBQUNLLFVBQUQsRUFBT0MsVUFBUCxFQUFhQyxjQUFiLEVBQXFCQyxjQUFyQixFQUE2QkMsTUFBN0IsRUFBaUNDLFFBQWpDLEVBQXBCOztBQUVBLFNBQVNMLElBQVQsQ0FBY1AsSUFBZCxFQUFvQjtBQUNsQixTQUFPZCxTQUFTMkIs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anMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgYmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuY29uc3QgX3Nhc3MgPSByZXF1aXJlKCdub2RlLXNhc3MnKTtcbmNvbnN0IF9sZXNzID0gcmVxdWlyZSgnbGVzcycpO1xuY29uc3QgX3N0eWx1cyA9IHJlcXVpcmUoJ3N0eWx1cycpO1xuY29uc3QgX2NvZmZlZSA9IHJlcXVpcmUoJ2NvZmZlZS1zY3JpcHQnKTtcbmNvbnN0IGJhYmVsID0gcmVxdWlyZSgnYmFiZWwtY29yZScpO1xuY29uc3Qge3JvbGx1cH0gPSByZXF1aXJlKCdyb2xsdXAnKTtcbmNvbnN0IHJvbGx1cEJhYmVsID0gcmVxdWlyZSgncm9sbHVwLXBsdWdpbi1iYWJlbCcpO1xuY29uc3QgcG9zdGNzcyA9IHJlcXVpcmUoJ3Bvc3Rjc3MnKTtcbmNvbnN0IGNzc25leHQgPSByZXF1aXJlKCdwb3N0Y3NzLWNzc25leHQnKTtcbmNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHRyYW5zcGlsZShmaWxlKSB7XG4gIGNvbnN0IHRyYW5zcGlsZWQgPSB0cmFuc3BpbGVyc1tmaWxlLnR5cGVdKGZpbGUpO1xuICByZXR1cm4gdHJhbnNwaWxlZC50aGVuKHJlc3VsdCA9PiBfLmFzc2lnbihmaWxlLCByZXN1bHQpKTtcbn07XG5cbmNvbnN0IHRyYW5zcGlsZXJzID0ge3Nhc3MsIGxlc3MsIHN0eWx1cywgY29mZmVlLCBqcywgY3NzfTtcblxuZnVuY3Rpb24gc2FzcyhmaWxlKSB7XG4gIHJldHVybiBibHVlYmlyZC5wcm9taXNpZnkoX3Nhc3MucmVuZGVyKSh7XG4gICAgZGF0YTogZmlsZS5jb250ZW50LFxuICAgIGZpbGU6IGZpbGUuc3JjLFxuICAgIGluY2x1ZGVQYXRoczogW2ZpbGUuZGlyXSxcbiAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgb3V0RmlsZTogZmlsZS5uYW1lLFxuICAgIG9taXRTb3VyY2VNYXBVcmw6IHRydWVcbiAgfSlcbiAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgY29udGVudDogcmVzdWx0LmNzcy50b1N0cmluZygpLFxuICAgIG1hcDogcmVzdWx0Lm1hcC50b1N0cmluZygpLFxuICAgIG1hcEltcG9ydHM6IF8ubWFwKHJlc3VsdC5zdGF0cy5pbmNsdWRlZEZpbGVzLCBpbmNsdWRlZCA9PiBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIGluY2x1ZGVkKSlcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBsZXNzKGZpbGUpIHtcbiAgcmV0dXJuIF9sZXNzLnJlbmRlcihmaWxlLmNvbnRlbnQsIHtcbiAgICBmaWxlbmFtZTogZmlsZS5zcmMsXG4gICAgc291cmNlTWFwOiB7fSxcbiAgICBwYXRoczogW2ZpbGUuZGlyXVxuICB9KVxuICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICBjb250ZW50OiByZXN1bHQuY3NzLnRvU3RyaW5nKCksXG4gICAgbWFwOiByZXN1bHQubWFwLFxuICAgIG1hcEltcG9ydHM6IHJlc3VsdC5pbXBvcnRzXG4gIH0pKTtcbn1cblxuZnVuY3Rpb24gc3R5bHVzKGZpbGUpIHtcbiAgbGV0IHJlc3VsdDtcbiAgY29uc3Qgc3R5bGUgPSBfc3R5bHVzKGZpbGUuY29udGVudClcbiAgICAuc2V0KCdmaWxlbmFtZScsIGZpbGUuc3JjKVxuICAgIC5zZXQoJ3NvdXJjZW1hcCcsIHtjb21tZW50OiBmYWxzZX0pXG4gICAgLmRlZmluZSgndXJsJywgX3N0eWx1cy5yZXNvbHZlcigpKTtcblxuICBzdHlsZS5yZW5kZXIoKGVyciwgY3NzKSA9PiB7XG4gICAgcmVzdWx0ID0ge1xuICAgICAgY29udGVudDogY3NzLFxuICAgICAgbWFwOiBzdHlsZS5zb3VyY2VtYXAsXG4gICAgICBtYXBJbXBvcnRzOiBzdHlsZS5kZXBzKClcbiAgICB9O1xuICB9KTtcblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGNvZmZlZShmaWxlKSB7XG4gIGNvbnN0IG9wdHMgPSB7XG4gICAgc291cmNlTWFwOiB0cnVlLFxuICAgIGZpbGVuYW1lOiBmaWxlLnNyYyxcbiAgICBzb3VyY2VGaWxlczogW2ZpbGUuc3JjXVxuICB9O1xuICBjb25zdCBjb21waWxlZCA9IF9jb2ZmZWUuY29tcGlsZShmaWxlLmNvbnRlbnQsIG9wdHMpO1xuICBjb25zdCByZXN1bHQgPSB7XG4gICAgY29udGVudDogY29tcGlsZWQuanMsXG4gICAgbWFwOiBjb21waWxlZC52M1NvdXJjZU1hcFxuICB9O1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGpzKGZpbGUpIHtcbiAgY29uc3QgYmFiZWxPcHRzID0ge1xuICAgIGZpbGVuYW1lOiBmaWxlLmJhc2UsXG4gICAgcHJlc2V0czogW1xuICAgICAgWydiYWJlbC1wcmVzZXQtZXMyMDE1Jywge21vZHVsZXM6IGZhbHNlfV0sXG4gICAgICAnYmFiZWwtcHJlc2V0LWVzMjAxNicsXG4gICAgICAnYmFiZWwtcHJlc2V0LWVzMjAxNycsXG4gICAgICAnYmFiZWwtcHJlc2V0LXJlYWN0J1xuICAgIF0sXG4gICAgcGx1Z2luczogW1xuICAgICAgJ2JhYmVsLXBsdWdpbi1leHRlcm5hbC1oZWxwZXJzJ1xuICAgIF0sXG4gICAgc291cmNlTWFwczogdHJ1ZSxcbiAgICBzb3VyY2VGaWxlTmFtZTogZmlsZS5zcmMsXG4gICAgYXN0OiBmYWxzZSxcbiAgICBjb21wYWN0OiBmYWxzZVxuICB9O1xuXG4gIGNvbnN0IHJvbGx1cE9wdHMgPSB7XG4gICAgZW50cnk6IGZpbGUuc3JjLFxuICAgIHBsdWdpbnM6IFtcbiAgICAgIHJvbGx1cEJhYmVsKGJhYmVsT3B0cylcbiAgICBdXG4gIH07XG5cbiAgY29uc3Qgb3V0cHV0ID0gcm9sbHVwKHJvbGx1cE9wdHMpXG4gICAgLnRoZW4oYnVuZGxlID0+IHtcbiAgICAgIGNvbnN0IHRlbXAgPSBidW5kbGUuZ2VuZXJhdGUoe1xuICAgICAgICBmb3JtYXQ6ICdlcycsXG4gICAgICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICAgICAgc291cmNlTWFwRmlsZTogY29uZmlnLnNyY0RpclxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgIGNvbnRlbnQ6IHRlbXAuY29kZSxcbiAgICAgICAgbWFwOiB0ZW1wLm1hcCxcbiAgICAgICAgbWFwSW1wb3J0czogdGVtcC5tYXAuc291cmNlc1xuICAgICAgfTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSlcbiAgICAuY2F0Y2gocmVzdWx0ID0+IHtjb25zb2xlLmxvZyhyZXN1bHQpfSk7XG5cbiAgcmV0dXJuIG91dHB1dDtcblxuICAvKlxuICBjb25zdCB0cmFuc2Zvcm1lZCA9IGJhYmVsLnRyYW5zZm9ybShmaWxlLmNvbnRlbnQsIG9wdHMpO1xuICBjb25zdCByZXN1bHQgPSB7XG4gICAgY29udGVudDogdHJhbnNmb3JtZWQuY29kZSxcbiAgICBtYXA6IHRyYW5zZm9ybWVkLm1hcFxuICB9O1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICovXG59XG5cbmZ1bmN0aW9uIGNzcyhmaWxlKSB7XG4gIHJldHVybiBwb3N0Y3NzKFtjc3NuZXh0XSlcbiAgICAucHJvY2VzcyhmaWxlLmNvbnRlbnQsIHtcbiAgICAgIGZyb206IGZpbGUuc3JjLFxuICAgICAgbWFwOiB7XG4gICAgICAgIHByZXY6IGZpbGUubWFwLFxuICAgICAgICBpbmxpbmU6IGZhbHNlLFxuICAgICAgICBzb3VyY2VzQ29udGVudDogZmFsc2UsXG4gICAgICAgIGFubm90YXRpb246IGZhbHNlXG4gICAgICB9XG4gICAgfSlcbiAgICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MsXG4gICAgICBtYXA6IHJlc3VsdC5tYXAudG9TdHJpbmcoKVxuICAgIH0pKTtcbn1cbiJdfQ==
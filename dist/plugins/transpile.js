'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  var opts = {
    filename: file.base,
    presets: ['babel-preset-es2015', 'babel-preset-es2016', 'babel-preset-es2017'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };
  var transformed = babel.transform(file.content, opts);
  var result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicG9zdGNzcyIsImNzc25leHQiLCJtb2R1bGUiLCJleHBvcnRzIiwidHJhbnNwaWxlIiwiZmlsZSIsInRyYW5zcGlsZWQiLCJ0cmFuc3BpbGVycyIsInR5cGUiLCJ0aGVuIiwiYXNzaWduIiwicmVzdWx0Iiwic2FzcyIsImxlc3MiLCJzdHlsdXMiLCJjb2ZmZWUiLCJqcyIsImNzcyIsInByb21pc2lmeSIsInJlbmRlciIsImRhdGEiLCJjb250ZW50Iiwic3JjIiwiaW5jbHVkZVBhdGhzIiwiZGlyIiwic291cmNlTWFwIiwib3V0RmlsZSIsIm5hbWUiLCJvbWl0U291cmNlTWFwVXJsIiwidG9TdHJpbmciLCJtYXAiLCJtYXBJbXBvcnRzIiwic3RhdHMiLCJpbmNsdWRlZEZpbGVzIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwiaW5jbHVkZWQiLCJmaWxlbmFtZSIsInBhdGhzIiwiaW1wb3J0cyIsInN0eWxlIiwic2V0IiwiY29tbWVudCIsImRlZmluZSIsInJlc29sdmVyIiwiZXJyIiwic291cmNlbWFwIiwiZGVwcyIsIlByb21pc2UiLCJyZXNvbHZlIiwib3B0cyIsInNvdXJjZUZpbGVzIiwiY29tcGlsZWQiLCJjb21waWxlIiwidjNTb3VyY2VNYXAiLCJiYXNlIiwicHJlc2V0cyIsInNvdXJjZU1hcHMiLCJzb3VyY2VGaWxlTmFtZSIsImFzdCIsImNvbXBhY3QiLCJ0cmFuc2Zvcm1lZCIsInRyYW5zZm9ybSIsImNvZGUiLCJmcm9tIiwicHJldiIsImlubGluZSIsInNvdXJjZXNDb250ZW50IiwiYW5ub3RhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxPQUFPQyxRQUFRLE1BQVIsQ0FBYjtBQUNBLElBQU1DLElBQUlELFFBQVEs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QURVO0FBRXJCUSxTQUFLO0FBQ0hvQyxZQUFNN0QsS0FBS3lCLEdBRFI7QUFFSHFDLGNBQVEsS0FGTDtBQUdIQyxzQkFBZ0IsS0FIYjtBQUlIQyxrQkFBWTtBQUpUO0FBRmdCLEdBRGxCLEVBVUo1RCxJQVZJLENBVUM7QUFBQSxXQUFXO0FBQ2ZZLGVBQVNWLE9BQU9NLEdBREQ7QUFFZmEsV0FBS25CLE9BQU9tQixHQUFQLENBQVdELFFBQVg7QUFGVSxLQUFYO0FBQUEsR0FWRCxDQUFQO0FBY0QiLCJmaWxlIjoidHJhbnNwaWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmNvbnN0IF9zYXNzID0gcmVxdWlyZSgnbm9kZS1zYXNzJyk7XG5jb25zdCBfbGVzcyA9IHJlcXVpcmUoJ2xlc3MnKTtcbmNvbnN0IF9zdHlsdXMgPSByZXF1aXJlKCdzdHlsdXMnKTtcbmNvbnN0IF9jb2ZmZWUgPSByZXF1aXJlKCdjb2ZmZWUtc2NyaXB0Jyk7XG5jb25zdCBiYWJlbCA9IHJlcXVpcmUoJ2JhYmVsLWNvcmUnKTtcbmNvbnN0IHBvc3Rjc3MgPSByZXF1aXJlKCdwb3N0Y3NzJyk7XG5jb25zdCBjc3NuZXh0ID0gcmVxdWlyZSgncG9zdGNzcy1jc3NuZXh0Jyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gdHJhbnNwaWxlKGZpbGUpIHtcbiAgY29uc3QgdHJhbnNwaWxlZCA9IHRyYW5zcGlsZXJzW2ZpbGUudHlwZV0oZmlsZSk7XG4gIHJldHVybiB0cmFuc3BpbGVkLnRoZW4ocmVzdWx0ID0+IF8uYXNzaWduKGZpbGUsIHJlc3VsdCkpO1xufTtcblxuY29uc3QgdHJhbnNwaWxlcnMgPSB7c2FzcywgbGVzcywgc3R5bHVzLCBjb2ZmZWUsIGpzLCBjc3N9O1xuXG5mdW5jdGlvbiBzYXNzKGZpbGUpIHtcbiAgcmV0dXJuIGJsdWViaXJkLnByb21pc2lmeShfc2Fzcy5yZW5kZXIpKHtcbiAgICBkYXRhOiBmaWxlLmNvbnRlbnQsXG4gICAgZmlsZTogZmlsZS5zcmMsXG4gICAgaW5jbHVkZVBhdGhzOiBbZmlsZS5kaXJdLFxuICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICBvdXRGaWxlOiBmaWxlLm5hbWUsXG4gICAgb21pdFNvdXJjZU1hcFVybDogdHJ1ZVxuICB9KVxuICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICBjb250ZW50OiByZXN1bHQuY3NzLnRvU3RyaW5nKCksXG4gICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKCksXG4gICAgbWFwSW1wb3J0czogXy5tYXAocmVzdWx0LnN0YXRzLmluY2x1ZGVkRmlsZXMsIGluY2x1ZGVkID0+IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgaW5jbHVkZWQpKVxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGxlc3MoZmlsZSkge1xuICByZXR1cm4gX2xlc3MucmVuZGVyKGZpbGUuY29udGVudCwge1xuICAgIGZpbGVuYW1lOiBmaWxlLnNyYyxcbiAgICBzb3VyY2VNYXA6IHt9LFxuICAgIHBhdGhzOiBbZmlsZS5kaXJdXG4gIH0pXG4gIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MudG9TdHJpbmcoKSxcbiAgICBtYXA6IHJlc3VsdC5tYXAsXG4gICAgbWFwSW1wb3J0czogcmVzdWx0LmltcG9ydHNcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBzdHlsdXMoZmlsZSkge1xuICBsZXQgcmVzdWx0O1xuICBjb25zdCBzdHlsZSA9IF9zdHlsdXMoZmlsZS5jb250ZW50KVxuICAgIC5zZXQoJ2ZpbGVuYW1lJywgZmlsZS5zcmMpXG4gICAgLnNldCgnc291cmNlbWFwJywge2NvbW1lbnQ6IGZhbHNlfSlcbiAgICAuZGVmaW5lKCd1cmwnLCBfc3R5bHVzLnJlc29sdmVyKCkpO1xuXG4gIHN0eWxlLnJlbmRlcigoZXJyLCBjc3MpID0+IHtcbiAgICByZXN1bHQgPSB7XG4gICAgICBjb250ZW50OiBjc3MsXG4gICAgICBtYXA6IHN0eWxlLnNvdXJjZW1hcCxcbiAgICAgIG1hcEltcG9ydHM6IHN0eWxlLmRlcHMoKVxuICAgIH07XG4gIH0pO1xuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gY29mZmVlKGZpbGUpIHtcbiAgY29uc3Qgb3B0cyA9IHtcbiAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgZmlsZW5hbWU6IGZpbGUuc3JjLFxuICAgIHNvdXJjZUZpbGVzOiBbZmlsZS5zcmNdXG4gIH07XG4gIGNvbnN0IGNvbXBpbGVkID0gX2NvZmZlZS5jb21waWxlKGZpbGUuY29udGVudCwgb3B0cyk7XG4gIGNvbnN0IHJlc3VsdCA9IHtcbiAgICBjb250ZW50OiBjb21waWxlZC5qcyxcbiAgICBtYXA6IGNvbXBpbGVkLnYzU291cmNlTWFwXG4gIH07XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24ganMoZmlsZSkge1xuICBjb25zdCBvcHRzID0ge1xuICAgIGZpbGVuYW1lOiBmaWxlLmJhc2UsXG4gICAgcHJlc2V0czogWydiYWJlbC1wcmVzZXQtZXMyMDE1JywgJ2JhYmVsLXByZXNldC1lczIwMTYnLCAnYmFiZWwtcHJlc2V0LWVzMjAxNyddLFxuICAgIHNvdXJjZU1hcHM6IHRydWUsXG4gICAgc291cmNlRmlsZU5hbWU6IGZpbGUuc3JjLFxuICAgIGFzdDogZmFsc2UsXG4gICAgY29tcGFjdDogZmFsc2VcbiAgfTtcbiAgY29uc3QgdHJhbnNmb3JtZWQgPSBiYWJlbC50cmFuc2Zvcm0oZmlsZS5jb250ZW50LCBvcHRzKTtcbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIGNvbnRlbnQ6IHRyYW5zZm9ybWVkLmNvZGUsXG4gICAgbWFwOiB0cmFuc2Zvcm1lZC5tYXBcbiAgfTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xufVxuXG5mdW5jdGlvbiBjc3MoZmlsZSkge1xuICByZXR1cm4gcG9zdGNzcyhbY3NzbmV4dF0pXG4gICAgLnByb2Nlc3MoZmlsZS5jb250ZW50LCB7XG4gICAgICBmcm9tOiBmaWxlLnNyYyxcbiAgICAgIG1hcDoge1xuICAgICAgICBwcmV2OiBmaWxlLm1hcCxcbiAgICAgICAgaW5saW5lOiBmYWxzZSxcbiAgICAgICAgc291cmNlc0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgICBhbm5vdGF0aW9uOiBmYWxzZVxuICAgICAgfVxuICAgIH0pXG4gICAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgICBjb250ZW50OiByZXN1bHQuY3NzLFxuICAgICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKClcbiAgICB9KSk7XG59XG4iXX0=
'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');

var _require = require('rollup'),
    rollup = _require.rollup;

var rollupBabel = require('rollup-plugin-babel');
var rollupCommonJs = require('rollup-plugin-commonjs');
var rollupNodeResolve = require('rollup-plugin-node-resolve');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');
var config = require('../config');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  // TODO: unhack all the hacking
  var babelOpts = {
    filename: file.base,
    presets: [['babel-preset-es2015'], 'babel-preset-es2016', 'babel-preset-es2017', 'babel-preset-react'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };

  if (config.modules) {
    babelOpts.presets[0][1] = { modules: false };
    babelOpts.plugins = ['babel-plugin-external-helpers'];

    var rollupOpts = {
      entry: file.src,
      plugins: [rollupBabel(babelOpts), rollupNodeResolve(), rollupCommonJs()],
      treeshake: false
    };

    return rollup(rollupOpts).then(function (bundle) {
      var result = bundle.generate({
        format: config.modules === true ? 'es' : config.modules,
        sourceMap: true,
        sourceMapFile: config.srcDir
      });
      return {
        content: result.code,
        map: result.map,
        mapImports: result.map.sources
      };
    }).catch(function (result) {
      console.log(result);
    });
  }

  var transformed = babel.transform(file.content, babelOpts);
  var result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicm9sbHVwIiwicm9sbHVwQmFiZWwiLCJyb2xsdXBDb21tb25KcyIsInJvbGx1cE5vZGVSZXNvbHZlIiwicG9zdGNzcyIsImNzc25leHQiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIiwidHJhbnNwaWxlIiwiZmlsZSIsInRyYW5zcGlsZWQiLCJ0cmFuc3BpbGVycyIsInR5cGUiLCJ0aGVuIiwiYXNzaWduIiwicmVzdWx0Iiwic2FzcyIsImxlc3MiLCJzdHlsdXMiLCJjb2ZmZWUiLCJqcyIsImNzcyIsInByb21pc2lmeSIsInJlbmRlciIsImRhdGEiLCJjb250ZW50Iiwic3JjIiwiaW5jbHVkZVBhdGhzIiwiZGlyIiwic291cmNlTWFwIiwib3V0RmlsZSIsIm5hbWUiLCJvbWl0U291cmNlTWFwVXJsIiwidG9TdHJpbmciLCJtYXAiLCJtYXBJbXBvcnRzIiwic3RhdHMiLCJpbmNsdWRlZEZpbGVzIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwiaW5jbHVkZWQiLCJmaWxlbmFtZSIsInBhdGhzIiwiaW1wb3J0cyIsInN0eWxlIiwic2V0IiwiY29tbWVudCIsImRlZmluZSIsInJlc29sdmVyIiwiZXJyIiwic291cmNlbWFwIiwiZGVwcyIsIlByb21pc2UiLCJyZXNvbHZlIiwib3B0cyIsInNvdXJjZUZpbGVzIiwiY29tcGlsZWQiLCJjb21waWxlIiwidjNTb3VyY2VNYXAiLCJiYWJlbE9wdHMiLCJiYXNlIiwicHJlc2V0cyIsInNvdXJjZU1hcHMiLCJzb3VyY2VGaWxlTmFtZSIsImFzdCIsImNvbXBhY3QiLCJtb2R1bGVzIiwicGx1Z2lucyIsInJvbGx1cE9wdHMiLCJlbnRyeSIsInRyZWVzaGFrZSIsImJ1bmRsZSIsImdlbmVyYXRlIiwiZm9ybWF0Iiwic291cmNlTWFwRmlsZSIsInNyY0RpciIsImNvZGUiLCJzb3VyY2VzIiwiY2F0Y2giLCJjb25zb2xlIiwibG9nIiwidHJhbnNmb3JtZWQiLCJ0cmFuc2Zvcm0iLCJmcm9tIiwicHJldiIsImlubGluZSIsInNvdXJjZXNDb250ZW50IiwiYW5ub3RhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxPQUFPQyxRQUFRLE1BQVIsQ0FBYjtBQUNBLElBQU1DLElBQUlELFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUUsV0FBV0YsUUFBUSxVQUFSLENBQWpCO0FBQ0EsSUFBTUcsUUFBUUgsUUFBUSxXQUFSLENBQWQ7QUFDQSxJQUFNSSxRQUFRSixRQUFRLE1BQVIsQ0FBZDtBQUNBLElBQU1LLFVBQVVMLFFBQVEsUUFBUixDQUFoQjtBQUNBLElBQU1NLFVBQVVOLFFBQVEsZUFBUixDQUFoQjtBQUNBLElBQU1PLFFBQVFQLFFBQVEsWUFBUixDQUFkOztlQUNpQkEsUUFBUSxRQUFSLEM7SUFBVlEsTSxZQUFBQSxNOztBQUNQLElBQU1DLGNBQWNULFFBQVEscUJBQVIsQ0FBcEI7QUFDQSxJQUFNVSxpQkFBaUJWLFFBQVEsd0JBQVIsQ0FBdkI7QUFDQSxJQUFNVyxvQkFBb0JYLFFBQVEsNEJBQVIsQ0FBMUI7QUFDQSxJQUFNWSxVQUFVWixRQUFRLFNBQVIsQ0FBaEI7QUFDQSxJQUFNYSxVQUFVYixRQUFRLGlCQUFSLENBQWhCO0FBQ0EsSUFBTWMsU0FBU2QsUUFBUSxXQUFSLENBQWY7O0FBRUFlLE9BQU9DLE9BQVAsR0FBaUIsU0FBU0MsU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUI7QUFDeEMsTUFBTUMsYUFBYUMsWUFBWUYsS0FBS0csSUFBakIsRUFBdUJILElBQXZCLENBQW5CO0FBQ0EsU0FBT0MsV0FBV0csSUFBWCxDQUFnQjtBQUFBLFdBQVVyQixFQUFFc0IsTUFBRixDQUFTTCxJQUFULEVBQWVNLE1BQWYsQ0FBVjtBQUFBLEdBQWhCLENBQVA7QUFDRCxDQUhEOztBQUtBLElBQU1KLGNBQWMs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QURSO0FBRWIzQyxTQUFLZ0QsWUFBWWhEO0FBRkosR0FBZjtBQUlBLFNBQU9tQixRQUFRQyxPQUFSLENBQWdCdkMsTUFBaEIsQ0FBUDtBQUNEOztBQUVELFNBQVNNLEdBQVQsQ0FBYVosSUFBYixFQUFtQjtBQUNqQixTQUFPTixRQUFRLENBQUNDLE9BQUQsQ0FBUixFQUNKbUMsT0FESSxDQUNJOUIsS0FBS2dCLE9BRFQsRUFDa0I7QUFDckIyRCxVQUFNM0UsS0FBS2lCLEdBRFU7QUFFckJRLFNBQUs7QUFDSG1ELFlBQU01RSxLQUFLeUIsR0FEUjtBQUVIb0QsY0FBUSxLQUZMO0FBR0hDLHNCQUFnQixLQUhiO0FBSUhDLGtCQUFZO0FBSlQ7QUFGZ0IsR0FEbEIsRUFVSjNFLElBVkksQ0FVQztBQUFBLFdBQVc7QUFDZlksZUFBU1YsT0FBT00sR0FERDtBQUVmYSxXQUFLbkIsT0FBT21CLEdBQVAsQ0FBV0QsUUFBWDtBQUZVLEtBQVg7QUFBQSxHQVZELENBQVA7QUFjRCIsImZpbGUiOiJ0cmFuc3BpbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgYmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuY29uc3QgX3Nhc3MgPSByZXF1aXJlKCdub2RlLXNhc3MnKTtcbmNvbnN0IF9sZXNzID0gcmVxdWlyZSgnbGVzcycpO1xuY29uc3QgX3N0eWx1cyA9IHJlcXVpcmUoJ3N0eWx1cycpO1xuY29uc3QgX2NvZmZlZSA9IHJlcXVpcmUoJ2NvZmZlZS1zY3JpcHQnKTtcbmNvbnN0IGJhYmVsID0gcmVxdWlyZSgnYmFiZWwtY29yZScpO1xuY29uc3Qge3JvbGx1cH0gPSByZXF1aXJlKCdyb2xsdXAnKTtcbmNvbnN0IHJvbGx1cEJhYmVsID0gcmVxdWlyZSgncm9sbHVwLXBsdWdpbi1iYWJlbCcpO1xuY29uc3Qgcm9sbHVwQ29tbW9uSnMgPSByZXF1aXJlKCdyb2xsdXAtcGx1Z2luLWNvbW1vbmpzJyk7XG5jb25zdCByb2xsdXBOb2RlUmVzb2x2ZSA9IHJlcXVpcmUoJ3JvbGx1cC1wbHVnaW4tbm9kZS1yZXNvbHZlJyk7XG5jb25zdCBwb3N0Y3NzID0gcmVxdWlyZSgncG9zdGNzcycpO1xuY29uc3QgY3NzbmV4dCA9IHJlcXVpcmUoJ3Bvc3Rjc3MtY3NzbmV4dCcpO1xuY29uc3QgY29uZmlnID0gcmVxdWlyZSgnLi4vY29uZmlnJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gdHJhbnNwaWxlKGZpbGUpIHtcbiAgY29uc3QgdHJhbnNwaWxlZCA9IHRyYW5zcGlsZXJzW2ZpbGUudHlwZV0oZmlsZSk7XG4gIHJldHVybiB0cmFuc3BpbGVkLnRoZW4ocmVzdWx0ID0+IF8uYXNzaWduKGZpbGUsIHJlc3VsdCkpO1xufTtcblxuY29uc3QgdHJhbnNwaWxlcnMgPSB7c2FzcywgbGVzcywgc3R5bHVzLCBjb2ZmZWUsIGpzLCBjc3N9O1xuXG5mdW5jdGlvbiBzYXNzKGZpbGUpIHtcbiAgcmV0dXJuIGJsdWViaXJkLnByb21pc2lmeShfc2Fzcy5yZW5kZXIpKHtcbiAgICBkYXRhOiBmaWxlLmNvbnRlbnQsXG4gICAgZmlsZTogZmlsZS5zcmMsXG4gICAgaW5jbHVkZVBhdGhzOiBbZmlsZS5kaXJdLFxuICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICBvdXRGaWxlOiBmaWxlLm5hbWUsXG4gICAgb21pdFNvdXJjZU1hcFVybDogdHJ1ZVxuICB9KVxuICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICBjb250ZW50OiByZXN1bHQuY3NzLnRvU3RyaW5nKCksXG4gICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKCksXG4gICAgbWFwSW1wb3J0czogXy5tYXAocmVzdWx0LnN0YXRzLmluY2x1ZGVkRmlsZXMsIGluY2x1ZGVkID0+IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgaW5jbHVkZWQpKVxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGxlc3MoZmlsZSkge1xuICByZXR1cm4gX2xlc3MucmVuZGVyKGZpbGUuY29udGVudCwge1xuICAgIGZpbGVuYW1lOiBmaWxlLnNyYyxcbiAgICBzb3VyY2VNYXA6IHt9LFxuICAgIHBhdGhzOiBbZmlsZS5kaXJdXG4gIH0pXG4gIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MudG9TdHJpbmcoKSxcbiAgICBtYXA6IHJlc3VsdC5tYXAsXG4gICAgbWFwSW1wb3J0czogcmVzdWx0LmltcG9ydHNcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBzdHlsdXMoZmlsZSkge1xuICBsZXQgcmVzdWx0O1xuICBjb25zdCBzdHlsZSA9IF9zdHlsdXMoZmlsZS5jb250ZW50KVxuICAgIC5zZXQoJ2ZpbGVuYW1lJywgZmlsZS5zcmMpXG4gICAgLnNldCgnc291cmNlbWFwJywge2NvbW1lbnQ6IGZhbHNlfSlcbiAgICAuZGVmaW5lKCd1cmwnLCBfc3R5bHVzLnJlc29sdmVyKCkpO1xuXG4gIHN0eWxlLnJlbmRlcigoZXJyLCBjc3MpID0+IHtcbiAgICByZXN1bHQgPSB7XG4gICAgICBjb250ZW50OiBjc3MsXG4gICAgICBtYXA6IHN0eWxlLnNvdXJjZW1hcCxcbiAgICAgIG1hcEltcG9ydHM6IHN0eWxlLmRlcHMoKVxuICAgIH07XG4gIH0pO1xuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gY29mZmVlKGZpbGUpIHtcbiAgY29uc3Qgb3B0cyA9IHtcbiAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgZmlsZW5hbWU6IGZpbGUuc3JjLFxuICAgIHNvdXJjZUZpbGVzOiBbZmlsZS5zcmNdXG4gIH07XG4gIGNvbnN0IGNvbXBpbGVkID0gX2NvZmZlZS5jb21waWxlKGZpbGUuY29udGVudCwgb3B0cyk7XG4gIGNvbnN0IHJlc3VsdCA9IHtcbiAgICBjb250ZW50OiBjb21waWxlZC5qcyxcbiAgICBtYXA6IGNvbXBpbGVkLnYzU291cmNlTWFwXG4gIH07XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24ganMoZmlsZSkge1xuICAvLyBUT0RPOiB1bmhhY2sgYWxsIHRoZSBoYWNraW5nXG4gIGNvbnN0IGJhYmVsT3B0cyA9IHtcbiAgICBmaWxlbmFtZTogZmlsZS5iYXNlLFxuICAgIHByZXNldHM6IFtcbiAgICAgIFsnYmFiZWwtcHJlc2V0LWVzMjAxNSddLFxuICAgICAgJ2JhYmVsLXByZXNldC1lczIwMTYnLFxuICAgICAgJ2JhYmVsLXByZXNldC1lczIwMTcnLFxuICAgICAgJ2JhYmVsLXByZXNldC1yZWFjdCdcbiAgICBdLFxuICAgIHNvdXJjZU1hcHM6IHRydWUsXG4gICAgc291cmNlRmlsZU5hbWU6IGZpbGUuc3JjLFxuICAgIGFzdDogZmFsc2UsXG4gICAgY29tcGFjdDogZmFsc2VcbiAgfTtcblxuICBpZiAoY29uZmlnLm1vZHVsZXMpIHtcbiAgICBiYWJlbE9wdHMucHJlc2V0c1swXVsxXSA9IHttb2R1bGVzOiBmYWxzZX07XG4gICAgYmFiZWxPcHRzLnBsdWdpbnMgPSBbJ2JhYmVsLXBsdWdpbi1leHRlcm5hbC1oZWxwZXJzJ107XG5cbiAgICBjb25zdCByb2xsdXBPcHRzID0ge1xuICAgICAgZW50cnk6IGZpbGUuc3JjLFxuICAgICAgcGx1Z2luczogW1xuICAgICAgICByb2xsdXBCYWJlbChiYWJlbE9wdHMpLFxuICAgICAgICByb2xsdXBOb2RlUmVzb2x2ZSgpLFxuICAgICAgICByb2xsdXBDb21tb25KcygpXG4gICAgICBdLFxuICAgICAgdHJlZXNoYWtlOiBmYWxzZVxuICAgIH07XG5cbiAgICByZXR1cm4gcm9sbHVwKHJvbGx1cE9wdHMpXG4gICAgICAudGhlbihidW5kbGUgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBidW5kbGUuZ2VuZXJhdGUoe1xuICAgICAgICAgIGZvcm1hdDogY29uZmlnLm1vZHVsZXMgPT09IHRydWUgPyAnZXMnIDogY29uZmlnLm1vZHVsZXMsXG4gICAgICAgICAgc291cmNlTWFwOiB0cnVlLFxuICAgICAgICAgIHNvdXJjZU1hcEZpbGU6IGNvbmZpZy5zcmNEaXJcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29udGVudDogcmVzdWx0LmNvZGUsXG4gICAgICAgICAgbWFwOiByZXN1bHQubWFwLFxuICAgICAgICAgIG1hcEltcG9ydHM6IHJlc3VsdC5tYXAuc291cmNlc1xuICAgICAgICB9O1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChyZXN1bHQgPT4ge2NvbnNvbGUubG9nKHJlc3VsdCl9KTtcbiAgfVxuXG4gIGNvbnN0IHRyYW5zZm9ybWVkID0gYmFiZWwudHJhbnNmb3JtKGZpbGUuY29udGVudCwgYmFiZWxPcHRzKTtcbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIGNvbnRlbnQ6IHRyYW5zZm9ybWVkLmNvZGUsXG4gICAgbWFwOiB0cmFuc2Zvcm1lZC5tYXBcbiAgfTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xufVxuXG5mdW5jdGlvbiBjc3MoZmlsZSkge1xuICByZXR1cm4gcG9zdGNzcyhbY3NzbmV4dF0pXG4gICAgLnByb2Nlc3MoZmlsZS5jb250ZW50LCB7XG4gICAgICBmcm9tOiBmaWxlLnNyYyxcbiAgICAgIG1hcDoge1xuICAgICAgICBwcmV2OiBmaWxlLm1hcCxcbiAgICAgICAgaW5saW5lOiBmYWxzZSxcbiAgICAgICAgc291cmNlc0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgICBhbm5vdGF0aW9uOiBmYWxzZVxuICAgICAgfVxuICAgIH0pXG4gICAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgICBjb250ZW50OiByZXN1bHQuY3NzLFxuICAgICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKClcbiAgICB9KSk7XG59XG4iXX0=
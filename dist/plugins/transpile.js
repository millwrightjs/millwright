'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');

var _require = require('rollup'),
    rollup = _require.rollup;

var rollupBabel = require('rollup-plugin-babel');
var rollupCommonJs = require('rollup-plugin-commonjs');
var rollupNodeResolve = require('rollup-plugin-node-resolve');
var rollupEnv = require('rollup-plugin-env');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');
var config = require('../config');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  // TODO: unhack all the hacking
  var babelOpts = {
    filename: file.base,
    presets: [['babel-preset-es2015'], 'babel-preset-es2016', 'babel-preset-es2017', 'babel-preset-react'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };

  var nodeResolveOpts = {
    browser: true,
    jsnext: true,
    main: true
  };

  var commonJsOpts = {};

  if (config.modules) {
    babelOpts.presets[0][1] = { modules: false };

    if (config.namedExports) {
      Object.assign(commonJsOpts, { namedExports: config.namedExports });
    }

    var rollupOpts = {
      entry: file.src,
      plugins: [rollupEnv({ NODE_ENV: 'production' }), rollupNodeResolve(nodeResolveOpts),

      // Leaving this as a working example for a react/react-router app, but
      // Rollup won't take Millwright forward because it can't consume modules
      // without configuration - manually adding namedExports is often a requirement.
      // Webpack's Node API is probably our only path forward.
      rollupCommonJs(commonJsOpts), rollupBabel(babelOpts)]
    };

    return rollup(rollupOpts).then(function (bundle) {
      var result = bundle.generate({
        format: config.modules === true ? 'es' : config.modules,
        sourceMap: true,
        sourceMapFile: config.srcDir
      });
      return {
        content: result.code,
        map: result.map,
        mapImports: result.map.sources
      };
    }).catch(function (err) {
      return console.log(err);
    });
  }

  var transformed = babel.transform(file.content, babelOpts);
  var result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicm9sbHVwIiwicm9sbHVwQmFiZWwiLCJyb2xsdXBDb21tb25KcyIsInJvbGx1cE5vZGVSZXNvbHZlIiwicm9sbHVwRW52IiwicG9zdGNzcyIsImNzc25leHQiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIiwidHJhbnNwaWxlIiwiZmlsZSIsInRyYW5zcGlsZWQiLCJ0cmFuc3BpbGVycyIsInR5cGUiLCJ0aGVuIiwiYXNzaWduIiwicmVzdWx0Iiwic2FzcyIsImxlc3MiLCJzdHlsdXMiLCJjb2ZmZWUiLCJqcyIsImNzcyIsInByb21pc2lmeSIsInJlbmRlciIsImRhdGEiLCJjb250ZW50Iiwic3JjIiwiaW5jbHVkZVBhdGhzIiwiZGlyIiwic291cmNlTWFwIiwib3V0RmlsZSIsIm5hbWUiLCJvbWl0U291cmNlTWFwVXJsIiwidG9TdHJpbmciLCJtYXAiLCJtYXBJbXBvcnRzIiwic3RhdHMiLCJpbmNsdWRlZEZpbGVzIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwiaW5jbHVkZWQiLCJmaWxlbmFtZSIsInBhdGhzIiwiaW1wb3J0cyIsInN0eWxlIiwic2V0IiwiY29tbWVudCIsImRlZmluZSIsInJlc29sdmVyIiwiZXJyIiwic291cmNlbWFwIiwiZGVwcyIsIlByb21pc2UiLCJyZXNvbHZlIiwib3B0cyIsInNvdXJjZUZpbGVzIiwiY29tcGlsZWQiLCJjb21waWxlIiwidjNTb3VyY2VNYXAiLCJiYWJlbE9wdHMiLCJiYXNlIiwicHJlc2V0cyIsInNvdXJjZU1hcHMiLCJzb3VyY2VGaWxlTmFtZSIsImFzdCIsImNvbXBhY3QiLCJub2RlUmVzb2x2ZU9wdHMiLCJicm93c2VyIiwianNuZXh0IiwibWFpbiIsImNvbW1vbkpzT3B0cyIsIm1vZHVsZXMiLCJuYW1lZEV4cG9ydHMiLCJPYmplY3QiLCJyb2xsdXBPcHRzIiwiZW50cnkiLCJwbHVnaW5zIiwiTk9ERV9FTlYiLCJidW5kbGUiLCJnZW5lcmF0ZSIsImZvcm1hdCIsInNvdXJjZU1hcEZpbGUiLCJzcmNEaXIiLCJjb2RlIiwic291cmNlcyIsImNhdGNoIiwiY29uc29sZSIsImxvZyIsInRyYW5zZm9ybWVkIiwidHJhbnNmb3JtIiwiZnJvbSIsInByZXYiLCJpbmxpbmUiLCJzb3VyY2VzQ29udGVudCIsImFubm90YXRpb24iXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNQyxJQUFJRCxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1FLFdBQVdGLFFBQVEsVUFBUixDQUFqQjtBQUNBLElBQU1HLFFBQVFILFFBQVEsV0FBUixDQUFkO0FBQ0EsSUFBTUksUUFBUUosUUFBUSxNQUFSLENBQWQ7QUFDQSxJQUFNSyxVQUFVTCxRQUFRLFFBQVIsQ0FBaEI7QUFDQSxJQUFNTSxVQUFVTixRQUFRLGVBQVIsQ0FBaEI7QUFDQSxJQUFNTyxRQUFRUCxRQUFRLFlBQVIsQ0FBZDs7ZUFDaUJBLFFBQVEsUUFBUixDO0lBQVZRLE0sWUFBQUEsTTs7QUFDUCxJQUFNQyxjQUFjVCxRQUFRLHFCQUFSLENBQXBCO0FBQ0EsSUFBTVUsaUJBQWlCVixRQUFRLHdCQUFSLENBQXZCO0FBQ0EsSUFBTVcsb0JBQW9CWCxRQUFRLDRCQUFSLENBQTFCO0FBQ0EsSUFBTVksWUFBWVosUUFBUSxtQkFBUixDQUFsQjtBQUNBLElBQU1hLFVBQVViLFFBQVEsU0FBUixDQUFoQjtBQUNBLElBQU1jLFVBQVVkLFFBQVEsaUJBQVIsQ0FBaEI7QUFDQSxJQUFNZSxTQUFTZixRQUFRLFdBQVIsQ0FBZjs7QUFFQWdCLE9BQU9DLE9BQVAsR0FBaUIsU0FBU0MsU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUI7QUFDeEMsTUFBTUMsYUFBYUMsWUFBWUYsS0FBS0csSUFBakIsRUFBdUJILElBQXZC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RG5CO0FBRTdCM0MsbUJBQVcsSUFGa0I7QUFHN0JxRCx1QkFBZTdFLE9BQU84RTtBQUhPLE9BQWhCLENBQWY7QUFLQSxhQUFPO0FBQ0wxRCxpQkFBU1YsT0FBT3FFLElBRFg7QUFFTGxELGFBQUtuQixPQUFPbUIsR0FGUDtBQUdMQyxvQkFBWXBCLE9BQU9tQixHQUFQLENBQVdtRDtBQUhsQixPQUFQO0FBS0QsS0FaSSxFQWFKQyxLQWJJLENBYUU7QUFBQSxhQUFPQyxRQUFRQyxHQUFSLENBQVl0QyxHQUFaLENBQVA7QUFBQSxLQWJGLENBQVA7QUFjRDs7QUFFRCxNQUFNdUMsY0FBYzVGLE1BQU02RixTQUFOLENBQWdCakYsS0FBS2dCLE9BQXJCLEVBQThCbUMsU0FBOUIsQ0FBcEI7QUFDQSxNQUFNN0MsU0FBUztBQUNiVSxhQUFTZ0UsWUFBWUwsSUFEUjtBQUVibEQsU0FBS3VELFlBQVl2RDtBQUZKLEdBQWY7QUFJQSxTQUFPbUIsUUFBUUMsT0FBUixDQUFnQnZDLE1BQWhCLENBQVA7QUFDRDs7QUFFRCxTQUFTTSxHQUFULENBQWFaLElBQWIsRUFBbUI7QUFDakIsU0FBT04sUUFBUSxDQUFDQyxPQUFELENBQVIsRUFDSm1DLE9BREksQ0FDSTlCLEtBQUtnQixPQURULEVBQ2tCO0FBQ3JCa0UsVUFBTWxGLEtBQUtpQixHQURVO0FBRXJCUSxTQUFLO0FBQ0gwRCxZQUFNbkYsS0FBS3lCLEdBRFI7QUFFSDJELGNBQVEsS0FGTDtBQUdIQyxzQkFBZ0IsS0FIYjtBQUlIQyxrQkFBWTtBQUpUO0FBRmdCLEdBRGxCLEVBVUpsRixJQVZJLENBVUM7QUFBQSxXQUFXO0FBQ2ZZLGVBQVNWLE9BQU9NLEdBREQ7QUFFZmEsV0FBS25CLE9BQU9tQixHQUFQLENBQVdELFFBQVg7QUFGVSxLQUFYO0FBQUEsR0FWRCxDQUFQO0FBY0QiLCJmaWxlIjoidHJhbnNwaWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmNvbnN0IF9zYXNzID0gcmVxdWlyZSgnbm9kZS1zYXNzJyk7XG5jb25zdCBfbGVzcyA9IHJlcXVpcmUoJ2xlc3MnKTtcbmNvbnN0IF9zdHlsdXMgPSByZXF1aXJlKCdzdHlsdXMnKTtcbmNvbnN0IF9jb2ZmZWUgPSByZXF1aXJlKCdjb2ZmZWUtc2NyaXB0Jyk7XG5jb25zdCBiYWJlbCA9IHJlcXVpcmUoJ2JhYmVsLWNvcmUnKTtcbmNvbnN0IHtyb2xsdXB9ID0gcmVxdWlyZSgncm9sbHVwJyk7XG5jb25zdCByb2xsdXBCYWJlbCA9IHJlcXVpcmUoJ3JvbGx1cC1wbHVnaW4tYmFiZWwnKTtcbmNvbnN0IHJvbGx1cENvbW1vbkpzID0gcmVxdWlyZSgncm9sbHVwLXBsdWdpbi1jb21tb25qcycpO1xuY29uc3Qgcm9sbHVwTm9kZVJlc29sdmUgPSByZXF1aXJlKCdyb2xsdXAtcGx1Z2luLW5vZGUtcmVzb2x2ZScpO1xuY29uc3Qgcm9sbHVwRW52ID0gcmVxdWlyZSgncm9sbHVwLXBsdWdpbi1lbnYnKTtcbmNvbnN0IHBvc3Rjc3MgPSByZXF1aXJlKCdwb3N0Y3NzJyk7XG5jb25zdCBjc3NuZXh0ID0gcmVxdWlyZSgncG9zdGNzcy1jc3NuZXh0Jyk7XG5jb25zdCBjb25maWcgPSByZXF1aXJlKCcuLi9jb25maWcnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiB0cmFuc3BpbGUoZmlsZSkge1xuICBjb25zdCB0cmFuc3BpbGVkID0gdHJhbnNwaWxlcnNbZmlsZS50eXBlXShmaWxlKTtcbiAgcmV0dXJuIHRyYW5zcGlsZWQudGhlbihyZXN1bHQgPT4gXy5hc3NpZ24oZmlsZSwgcmVzdWx0KSk7XG59O1xuXG5jb25zdCB0cmFuc3BpbGVycyA9IHtzYXNzLCBsZXNzLCBzdHlsdXMsIGNvZmZlZSwganMsIGNzc307XG5cbmZ1bmN0aW9uIHNhc3MoZmlsZSkge1xuICByZXR1cm4gYmx1ZWJpcmQucHJvbWlzaWZ5KF9zYXNzLnJlbmRlcikoe1xuICAgIGRhdGE6IGZpbGUuY29udGVudCxcbiAgICBmaWxlOiBmaWxlLnNyYyxcbiAgICBpbmNsdWRlUGF0aHM6IFtmaWxlLmRpcl0sXG4gICAgc291cmNlTWFwOiB0cnVlLFxuICAgIG91dEZpbGU6IGZpbGUubmFtZSxcbiAgICBvbWl0U291cmNlTWFwVXJsOiB0cnVlXG4gIH0pXG4gIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MudG9TdHJpbmcoKSxcbiAgICBtYXA6IHJlc3VsdC5tYXAudG9TdHJpbmcoKSxcbiAgICBtYXBJbXBvcnRzOiBfLm1hcChyZXN1bHQuc3RhdHMuaW5jbHVkZWRGaWxlcywgaW5jbHVkZWQgPT4gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBpbmNsdWRlZCkpXG4gIH0pKTtcbn1cblxuZnVuY3Rpb24gbGVzcyhmaWxlKSB7XG4gIHJldHVybiBfbGVzcy5yZW5kZXIoZmlsZS5jb250ZW50LCB7XG4gICAgZmlsZW5hbWU6IGZpbGUuc3JjLFxuICAgIHNvdXJjZU1hcDoge30sXG4gICAgcGF0aHM6IFtmaWxlLmRpcl1cbiAgfSlcbiAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgY29udGVudDogcmVzdWx0LmNzcy50b1N0cmluZygpLFxuICAgIG1hcDogcmVzdWx0Lm1hcCxcbiAgICBtYXBJbXBvcnRzOiByZXN1bHQuaW1wb3J0c1xuICB9KSk7XG59XG5cbmZ1bmN0aW9uIHN0eWx1cyhmaWxlKSB7XG4gIGxldCByZXN1bHQ7XG4gIGNvbnN0IHN0eWxlID0gX3N0eWx1cyhmaWxlLmNvbnRlbnQpXG4gICAgLnNldCgnZmlsZW5hbWUnLCBmaWxlLnNyYylcbiAgICAuc2V0KCdzb3VyY2VtYXAnLCB7Y29tbWVudDogZmFsc2V9KVxuICAgIC5kZWZpbmUoJ3VybCcsIF9zdHlsdXMucmVzb2x2ZXIoKSk7XG5cbiAgc3R5bGUucmVuZGVyKChlcnIsIGNzcykgPT4ge1xuICAgIHJlc3VsdCA9IHtcbiAgICAgIGNvbnRlbnQ6IGNzcyxcbiAgICAgIG1hcDogc3R5bGUuc291cmNlbWFwLFxuICAgICAgbWFwSW1wb3J0czogc3R5bGUuZGVwcygpXG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xufVxuXG5mdW5jdGlvbiBjb2ZmZWUoZmlsZSkge1xuICBjb25zdCBvcHRzID0ge1xuICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICBmaWxlbmFtZTogZmlsZS5zcmMsXG4gICAgc291cmNlRmlsZXM6IFtmaWxlLnNyY11cbiAgfTtcbiAgY29uc3QgY29tcGlsZWQgPSBfY29mZmVlLmNvbXBpbGUoZmlsZS5jb250ZW50LCBvcHRzKTtcbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIGNvbnRlbnQ6IGNvbXBpbGVkLmpzLFxuICAgIG1hcDogY29tcGlsZWQudjNTb3VyY2VNYXBcbiAgfTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xufVxuXG5mdW5jdGlvbiBqcyhmaWxlKSB7XG4gIC8vIFRPRE86IHVuaGFjayBhbGwgdGhlIGhhY2tpbmdcbiAgY29uc3QgYmFiZWxPcHRzID0ge1xuICAgIGZpbGVuYW1lOiBmaWxlLmJhc2UsXG4gICAgcHJlc2V0czogW1xuICAgICAgWydiYWJlbC1wcmVzZXQtZXMyMDE1J10sXG4gICAgICAnYmFiZWwtcHJlc2V0LWVzMjAxNicsXG4gICAgICAnYmFiZWwtcHJlc2V0LWVzMjAxNycsXG4gICAgICAnYmFiZWwtcHJlc2V0LXJlYWN0J1xuICAgIF0sXG4gICAgc291cmNlTWFwczogdHJ1ZSxcbiAgICBzb3VyY2VGaWxlTmFtZTogZmlsZS5zcmMsXG4gICAgYXN0OiBmYWxzZSxcbiAgICBjb21wYWN0OiBmYWxzZVxuICB9O1xuXG4gIGNvbnN0IG5vZGVSZXNvbHZlT3B0cyA9IHtcbiAgICBicm93c2VyOiB0cnVlLFxuICAgIGpzbmV4dDogdHJ1ZSxcbiAgICBtYWluOiB0cnVlXG4gIH07XG5cbiAgY29uc3QgY29tbW9uSnNPcHRzID0ge307XG5cbiAgaWYgKGNvbmZpZy5tb2R1bGVzKSB7XG4gICAgYmFiZWxPcHRzLnByZXNldHNbMF1bMV0gPSB7bW9kdWxlczogZmFsc2V9O1xuXG4gICAgaWYgKGNvbmZpZy5uYW1lZEV4cG9ydHMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oY29tbW9uSnNPcHRzLCB7bmFtZWRFeHBvcnRzOiBjb25maWcubmFtZWRFeHBvcnRzfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgcm9sbHVwT3B0cyA9IHtcbiAgICAgIGVudHJ5OiBmaWxlLnNyYyxcbiAgICAgIHBsdWdpbnM6IFtcbiAgICAgICAgcm9sbHVwRW52KHtOT0RFX0VOVjogJ3Byb2R1Y3Rpb24nfSksXG4gICAgICAgIHJvbGx1cE5vZGVSZXNvbHZlKG5vZGVSZXNvbHZlT3B0cyksXG5cbiAgICAgICAgLy8gTGVhdmluZyB0aGlzIGFzIGEgd29ya2luZyBleGFtcGxlIGZvciBhIHJlYWN0L3JlYWN0LXJvdXRlciBhcHAsIGJ1dFxuICAgICAgICAvLyBSb2xsdXAgd29uJ3QgdGFrZSBNaWxsd3JpZ2h0IGZvcndhcmQgYmVjYXVzZSBpdCBjYW4ndCBjb25zdW1lIG1vZHVsZXNcbiAgICAgICAgLy8gd2l0aG91dCBjb25maWd1cmF0aW9uIC0gbWFudWFsbHkgYWRkaW5nIG5hbWVkRXhwb3J0cyBpcyBvZnRlbiBhIHJlcXVpcmVtZW50LlxuICAgICAgICAvLyBXZWJwYWNrJ3MgTm9kZSBBUEkgaXMgcHJvYmFibHkgb3VyIG9ubHkgcGF0aCBmb3J3YXJkLlxuICAgICAgICByb2xsdXBDb21tb25Kcyhjb21tb25Kc09wdHMpLFxuICAgICAgICByb2xsdXBCYWJlbChiYWJlbE9wdHMpXG4gICAgICBdXG4gICAgfTtcblxuICAgIHJldHVybiByb2xsdXAocm9sbHVwT3B0cylcbiAgICAgIC50aGVuKGJ1bmRsZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1bmRsZS5nZW5lcmF0ZSh7XG4gICAgICAgICAgZm9ybWF0OiBjb25maWcubW9kdWxlcyA9PT0gdHJ1ZSA/ICdlcycgOiBjb25maWcubW9kdWxlcyxcbiAgICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICAgICAgc291cmNlTWFwRmlsZTogY29uZmlnLnNyY0RpclxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb250ZW50OiByZXN1bHQuY29kZSxcbiAgICAgICAgICBtYXA6IHJlc3VsdC5tYXAsXG4gICAgICAgICAgbWFwSW1wb3J0czogcmVzdWx0Lm1hcC5zb3VyY2VzXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgfVxuXG4gIGNvbnN0IHRyYW5zZm9ybWVkID0gYmFiZWwudHJhbnNmb3JtKGZpbGUuY29udGVudCwgYmFiZWxPcHRzKTtcbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIGNvbnRlbnQ6IHRyYW5zZm9ybWVkLmNvZGUsXG4gICAgbWFwOiB0cmFuc2Zvcm1lZC5tYXBcbiAgfTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xufVxuXG5mdW5jdGlvbiBjc3MoZmlsZSkge1xuICByZXR1cm4gcG9zdGNzcyhbY3NzbmV4dF0pXG4gICAgLnByb2Nlc3MoZmlsZS5jb250ZW50LCB7XG4gICAgICBmcm9tOiBmaWxlLnNyYyxcbiAgICAgIG1hcDoge1xuICAgICAgICBwcmV2OiBmaWxlLm1hcCxcbiAgICAgICAgaW5saW5lOiBmYWxzZSxcbiAgICAgICAgc291cmNlc0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgICBhbm5vdGF0aW9uOiBmYWxzZVxuICAgICAgfVxuICAgIH0pXG4gICAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgICBjb250ZW50OiByZXN1bHQuY3NzLFxuICAgICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKClcbiAgICB9KSk7XG59XG4iXX0=
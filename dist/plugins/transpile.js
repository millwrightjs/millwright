'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  var opts = {
    filename: file.base,
    presets: ['babel-preset-es2015', 'babel-preset-es2016', 'babel-preset-es2017', 'babel-preset-react'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };
  var transformed = babel.transform(file.content, opts);
  var result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicG9zdGNzcyIsImNzc25leHQiLCJtb2R1bGUiLCJleHBvcnRzIiwidHJhbnNwaWxlIiwiZmlsZSIsInRyYW5zcGlsZWQiLCJ0cmFuc3BpbGVycyIsInR5cGUiLCJ0aGVuIiwiYXNzaWduIiwicmVzdWx0Iiwic2FzcyIsImxlc3MiLCJzdHlsdXMiLCJjb2ZmZWUiLCJqcyIsImNzcyIsInByb21pc2lmeSIsInJlbmRlciIsImRhdGEiLCJjb250ZW50Iiwic3JjIiwiaW5jbHVkZVBhdGhzIiwiZGlyIiwic291cmNlTWFwIiwib3V0RmlsZSIsIm5hbWUiLCJvbWl0U291cmNlTWFwVXJsIiwidG9TdHJpbmciLCJtYXAiLCJtYXBJbXBvcnRzIiwic3RhdHMiLCJpbmNsdWRlZEZpbGVzIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwiaW5jbHVkZWQiLCJmaWxlbmFtZSIsInBhdGhzIiwiaW1wb3J0cyIsInN0eWxlIiwic2V0IiwiY29tbWVudCIsImRlZmluZSIsInJlc29sdmVyIiwiZXJyIiwic291cmNlbWFwIiwiZGVwcyIsIlByb21pc2UiLCJyZXNvbHZlIiwib3B0cyIsInNvdXJjZUZpbGVzIiwiY29tcGlsZWQiLCJjb21waWxlIiwidjNTb3VyY2VNYXAiLCJiYXNlIiwicHJlc2V0cyIsInNvdXJjZU1hcHMiLCJzb3VyY2VGaWxlTmFtZSIsImFzdCIsImNvbXBhY3QiLCJ0cmFuc2Zvcm1lZCIsInRyYW5zZm9ybSIsImNvZGUiLCJmcm9tIiwicHJldiIsImlubGluZSIsInNvdXJjZXNDb250ZW50IiwiYW5ub3RhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxPQUFPQyxRQUFRLE1BQVIsQ0FBYjtBQUNBLElBQU1DLElBQUlELFFBQVEs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QUFLaUIsR0FEVTtBQUVyQlEsU0FBSztBQUNIb0MsWUFBTTdELEtBQUt5QixHQURSO0FBRUhxQyxjQUFRLEtBRkw7QUFHSEMsc0JBQWdCLEtBSGI7QUFJSEMsa0JBQVk7QUFKVDtBQUZnQixHQURsQixFQVVKNUQsSUFWSSxDQVVDO0FBQUEsV0FBVztBQUNmWSxlQUFTVixPQUFPTSxHQUREO0FBRWZhLFdBQUtuQixPQUFPbUIsR0FBUCxDQUFXRCxRQUFYO0FBRlUsS0FBWDtBQUFBLEdBVkQsQ0FBUDtBQWNEIiwiZmlsZSI6InRyYW5zcGlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCBfc2FzcyA9IHJlcXVpcmUoJ25vZGUtc2FzcycpO1xuY29uc3QgX2xlc3MgPSByZXF1aXJlKCdsZXNzJyk7XG5jb25zdCBfc3R5bHVzID0gcmVxdWlyZSgnc3R5bHVzJyk7XG5jb25zdCBfY29mZmVlID0gcmVxdWlyZSgnY29mZmVlLXNjcmlwdCcpO1xuY29uc3QgYmFiZWwgPSByZXF1aXJlKCdiYWJlbC1jb3JlJyk7XG5jb25zdCBwb3N0Y3NzID0gcmVxdWlyZSgncG9zdGNzcycpO1xuY29uc3QgY3NzbmV4dCA9IHJlcXVpcmUoJ3Bvc3Rjc3MtY3NzbmV4dCcpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHRyYW5zcGlsZShmaWxlKSB7XG4gIGNvbnN0IHRyYW5zcGlsZWQgPSB0cmFuc3BpbGVyc1tmaWxlLnR5cGVdKGZpbGUpO1xuICByZXR1cm4gdHJhbnNwaWxlZC50aGVuKHJlc3VsdCA9PiBfLmFzc2lnbihmaWxlLCByZXN1bHQpKTtcbn07XG5cbmNvbnN0IHRyYW5zcGlsZXJzID0ge3Nhc3MsIGxlc3MsIHN0eWx1cywgY29mZmVlLCBqcywgY3NzfTtcblxuZnVuY3Rpb24gc2FzcyhmaWxlKSB7XG4gIHJldHVybiBibHVlYmlyZC5wcm9taXNpZnkoX3Nhc3MucmVuZGVyKSh7XG4gICAgZGF0YTogZmlsZS5jb250ZW50LFxuICAgIGZpbGU6IGZpbGUuc3JjLFxuICAgIGluY2x1ZGVQYXRoczogW2ZpbGUuZGlyXSxcbiAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgb3V0RmlsZTogZmlsZS5uYW1lLFxuICAgIG9taXRTb3VyY2VNYXBVcmw6IHRydWVcbiAgfSlcbiAgLnRoZW4ocmVzdWx0ID0+ICh7XG4gICAgY29udGVudDogcmVzdWx0LmNzcy50b1N0cmluZygpLFxuICAgIG1hcDogcmVzdWx0Lm1hcC50b1N0cmluZygpLFxuICAgIG1hcEltcG9ydHM6IF8ubWFwKHJlc3VsdC5zdGF0cy5pbmNsdWRlZEZpbGVzLCBpbmNsdWRlZCA9PiBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIGluY2x1ZGVkKSlcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBsZXNzKGZpbGUpIHtcbiAgcmV0dXJuIF9sZXNzLnJlbmRlcihmaWxlLmNvbnRlbnQsIHtcbiAgICBmaWxlbmFtZTogZmlsZS5zcmMsXG4gICAgc291cmNlTWFwOiB7fSxcbiAgICBwYXRoczogW2ZpbGUuZGlyXVxuICB9KVxuICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICBjb250ZW50OiByZXN1bHQuY3NzLnRvU3RyaW5nKCksXG4gICAgbWFwOiByZXN1bHQubWFwLFxuICAgIG1hcEltcG9ydHM6IHJlc3VsdC5pbXBvcnRzXG4gIH0pKTtcbn1cblxuZnVuY3Rpb24gc3R5bHVzKGZpbGUpIHtcbiAgbGV0IHJlc3VsdDtcbiAgY29uc3Qgc3R5bGUgPSBfc3R5bHVzKGZpbGUuY29udGVudClcbiAgICAuc2V0KCdmaWxlbmFtZScsIGZpbGUuc3JjKVxuICAgIC5zZXQoJ3NvdXJjZW1hcCcsIHtjb21tZW50OiBmYWxzZX0pXG4gICAgLmRlZmluZSgndXJsJywgX3N0eWx1cy5yZXNvbHZlcigpKTtcblxuICBzdHlsZS5yZW5kZXIoKGVyciwgY3NzKSA9PiB7XG4gICAgcmVzdWx0ID0ge1xuICAgICAgY29udGVudDogY3NzLFxuICAgICAgbWFwOiBzdHlsZS5zb3VyY2VtYXAsXG4gICAgICBtYXBJbXBvcnRzOiBzdHlsZS5kZXBzKClcbiAgICB9O1xuICB9KTtcblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGNvZmZlZShmaWxlKSB7XG4gIGNvbnN0IG9wdHMgPSB7XG4gICAgc291cmNlTWFwOiB0cnVlLFxuICAgIGZpbGVuYW1lOiBmaWxlLnNyYyxcbiAgICBzb3VyY2VGaWxlczogW2ZpbGUuc3JjXVxuICB9O1xuICBjb25zdCBjb21waWxlZCA9IF9jb2ZmZWUuY29tcGlsZShmaWxlLmNvbnRlbnQsIG9wdHMpO1xuICBjb25zdCByZXN1bHQgPSB7XG4gICAgY29udGVudDogY29tcGlsZWQuanMsXG4gICAgbWFwOiBjb21waWxlZC52M1NvdXJjZU1hcFxuICB9O1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGpzKGZpbGUpIHtcbiAgY29uc3Qgb3B0cyA9IHtcbiAgICBmaWxlbmFtZTogZmlsZS5iYXNlLFxuICAgIHByZXNldHM6IFtcbiAgICAgICdiYWJlbC1wcmVzZXQtZXMyMDE1JyxcbiAgICAgICdiYWJlbC1wcmVzZXQtZXMyMDE2JyxcbiAgICAgICdiYWJlbC1wcmVzZXQtZXMyMDE3JyxcbiAgICAgICdiYWJlbC1wcmVzZXQtcmVhY3QnXG4gICAgXSxcbiAgICBzb3VyY2VNYXBzOiB0cnVlLFxuICAgIHNvdXJjZUZpbGVOYW1lOiBmaWxlLnNyYyxcbiAgICBhc3Q6IGZhbHNlLFxuICAgIGNvbXBhY3Q6IGZhbHNlXG4gIH07XG4gIGNvbnN0IHRyYW5zZm9ybWVkID0gYmFiZWwudHJhbnNmb3JtKGZpbGUuY29udGVudCwgb3B0cyk7XG4gIGNvbnN0IHJlc3VsdCA9IHtcbiAgICBjb250ZW50OiB0cmFuc2Zvcm1lZC5jb2RlLFxuICAgIG1hcDogdHJhbnNmb3JtZWQubWFwXG4gIH07XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gY3NzKGZpbGUpIHtcbiAgcmV0dXJuIHBvc3Rjc3MoW2Nzc25leHRdKVxuICAgIC5wcm9jZXNzKGZpbGUuY29udGVudCwge1xuICAgICAgZnJvbTogZmlsZS5zcmMsXG4gICAgICBtYXA6IHtcbiAgICAgICAgcHJldjogZmlsZS5tYXAsXG4gICAgICAgIGlubGluZTogZmFsc2UsXG4gICAgICAgIHNvdXJjZXNDb250ZW50OiBmYWxzZSxcbiAgICAgICAgYW5ub3RhdGlvbjogZmFsc2VcbiAgICAgIH1cbiAgICB9KVxuICAgIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgICAgY29udGVudDogcmVzdWx0LmNzcyxcbiAgICAgIG1hcDogcmVzdWx0Lm1hcC50b1N0cmluZygpXG4gICAgfSkpO1xufVxuIl19
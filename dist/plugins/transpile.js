'use strict';

var path = require('path');
var _ = require('lodash');
var bluebird = require('bluebird');
var _sass = require('node-sass');
var _less = require('less');
var _stylus = require('stylus');
var _coffee = require('coffee-script');
var babel = require('babel-core');

var _require = require('rollup'),
    rollup = _require.rollup;

var rollupBabel = require('rollup-plugin-babel');
var postcss = require('postcss');
var cssnext = require('postcss-cssnext');
var config = require('../config');

module.exports = function transpile(file) {
  var transpiled = transpilers[file.type](file);
  return transpiled.then(function (result) {
    return _.assign(file, result);
  });
};

var transpilers = { sass: sass, less: less, stylus: stylus, coffee: coffee, js: js, css: css };

function sass(file) {
  return bluebird.promisify(_sass.render)({
    data: file.content,
    file: file.src,
    includePaths: [file.dir],
    sourceMap: true,
    outFile: file.name,
    omitSourceMapUrl: true
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map.toString(),
      mapImports: _.map(result.stats.includedFiles, function (included) {
        return path.relative(process.cwd(), included);
      })
    };
  });
}

function less(file) {
  return _less.render(file.content, {
    filename: file.src,
    sourceMap: {},
    paths: [file.dir]
  }).then(function (result) {
    return {
      content: result.css.toString(),
      map: result.map,
      mapImports: result.imports
    };
  });
}

function stylus(file) {
  var result = void 0;
  var style = _stylus(file.content).set('filename', file.src).set('sourcemap', { comment: false }).define('url', _stylus.resolver());

  style.render(function (err, css) {
    result = {
      content: css,
      map: style.sourcemap,
      mapImports: style.deps()
    };
  });

  return Promise.resolve(result);
}

function coffee(file) {
  var opts = {
    sourceMap: true,
    filename: file.src,
    sourceFiles: [file.src]
  };
  var compiled = _coffee.compile(file.content, opts);
  var result = {
    content: compiled.js,
    map: compiled.v3SourceMap
  };
  return Promise.resolve(result);
}

function js(file) {
  // TODO: unhack all the hacking
  var babelOpts = {
    filename: file.base,
    presets: [['babel-preset-es2015'], 'babel-preset-es2016', 'babel-preset-es2017', 'babel-preset-react'],
    sourceMaps: true,
    sourceFileName: file.src,
    ast: false,
    compact: false
  };

  if (config.modules) {
    babelOpts.presets[0][1] = { modules: false };
    babelOpts.plugins = ['babel-plugin-external-helpers'];

    var rollupOpts = {
      entry: file.src,
      plugins: [rollupBabel(babelOpts)]
    };

    return rollup(rollupOpts).then(function (bundle) {
      var result = bundle.generate({
        format: config.modules === true ? 'es' : config.modules,
        sourceMap: true,
        sourceMapFile: config.srcDir
      });
      return {
        content: result.code,
        map: result.map,
        mapImports: result.map.sources
      };
    }).catch(function (result) {
      console.log(result);
    });
  }

  var transformed = babel.transform(file.content, babelOpts);
  var result = {
    content: transformed.code,
    map: transformed.map
  };
  return Promise.resolve(result);
}

function css(file) {
  return postcss([cssnext]).process(file.content, {
    from: file.src,
    map: {
      prev: file.map,
      inline: false,
      sourcesContent: false,
      annotation: false
    }
  }).then(function (result) {
    return {
      content: result.css,
      map: result.map.toString()
    };
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3RyYW5zcGlsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJibHVlYmlyZCIsIl9zYXNzIiwiX2xlc3MiLCJfc3R5bHVzIiwiX2NvZmZlZSIsImJhYmVsIiwicm9sbHVwIiwicm9sbHVwQmFiZWwiLCJwb3N0Y3NzIiwiY3NzbmV4dCIsImNvbmZpZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0cmFuc3BpbGUiLCJmaWxlIiwidHJhbnNwaWxlZCIsInRyYW5zcGlsZXJzIiwidHlwZSIsInRoZW4iLCJhc3NpZ24iLCJyZXN1bHQiLCJzYXNzIiwibGVzcyIsInN0eWx1cyIsImNvZmZlZSIsImpzIiwiY3NzIiwicHJvbWlzaWZ5IiwicmVuZGVyIiwiZGF0YSIsImNvbnRlbnQiLCJzcmMiLCJpbmNsdWRlUGF0aHMiLCJkaXIiLCJzb3VyY2VNYXAiLCJvdXRGaWxlIiwibmFtZSIsIm9taXRTb3VyY2VNYXBVcmwiLCJ0b1N0cmluZyIsIm1hcCIsIm1hcEltcG9ydHMiLCJzdGF0cyIsImluY2x1ZGVkRmlsZXMiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJpbmNsdWRlZCIsImZpbGVuYW1lIiwicGF0aHMiLCJpbXBvcnRzIiwic3R5bGUiLCJzZXQiLCJjb21tZW50IiwiZGVmaW5lIiwicmVzb2x2ZXIiLCJlcnIiLCJzb3VyY2VtYXAiLCJkZXBzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJvcHRzIiwic291cmNlRmlsZXMiLCJjb21waWxlZCIsImNvbXBpbGUiLCJ2M1NvdXJjZU1hcCIsImJhYmVsT3B0cyIsImJhc2UiLCJwcmVzZXRzIiwic291cmNlTWFwcyIsInNvdXJjZUZpbGVOYW1lIiwiYXN0IiwiY29tcGFjdCIsIm1vZHVsZXMiLCJwbHVnaW5zIiwicm9sbHVwT3B0cyIsImVudHJ5IiwiYnVuZGxlIiwiZ2VuZXJhdGUiLCJmb3JtYXQiLCJzb3VyY2VNYXBGaWxlIiwic3JjRGlyIiwiY29kZSIsInNvdXJjZXMiLCJjYXRjaCIsImNvbnNvbGUiLCJsb2ciLCJ0cmFuc2Zvcm1lZCIsInRyYW5zZm9ybSIsImZyb20iLCJwcmV2IiwiaW5saW5lIiwic291cmNlc0NvbnRlbnQiLCJhbm5vdGF0aW9uIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLE9BQU9DLFFBQVEsTUFBUixDQUFiO0FBQ0EsSUFBTUMsSUFBSUQsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNRSxXQUFXRixRQUFRLFVBQVIsQ0FBakI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLFdBQVIsQ0FBZDtBQUNBLElBQU1JLFFBQVFKLFFBQVEsTUFBUixDQUFkO0FBQ0EsSUFBTUssVUFBVUwsUUFBUSxRQUFSLENBQWhCO0FBQ0EsSUFBTU0sVUFBVU4sUUFBUSxlQUFSLENBQWhCO0FBQ0EsSUFBTU8sUUFBUVAsUUFBUSxZQUFSLENBQWQ7O2VBQ2lCQSxRQUFRLFFBQVIsQztJQUFWUSxNLFlBQUFBLE07O0FBQ1AsSUFBTUMsY0FBY1QsUUFBUSxxQkFBUixDQUFwQjtBQUNBLElBQU1VLFVBQVVWLFFBQVEsU0FBUixDQUFoQjtBQUNBLElBQU1XLFVBQVVYLFFBQVEsaUJBQVIsQ0FBaEI7QUFDQSxJQUFNWSxTQUFTWixRQUFRLFdBQVIsQ0FBZjs7QUFFQWEsT0FBT0MsT0FBUCxHQUFpQixTQUFTQyxTQUFULENBQW1CQyxJQUFuQixFQUF5QjtBQUN4QyxNQUFNQyxhQUFhQyxZQUFZRixLQUFLRyxJQUFqQixFQUF1QkgsSUFBdkIsQ0FBbkI7QUFDQSxTQUFPQyxXQUFXRyxJQUFYLENBQWdCO0FBQUEsV0FBVW5CLEVBQUVvQixNQUFGLENBQVNMLElBQVQsRUFBZU0sTUFBZixDQUFWO0FBQUEsR0FBaEIsQ0FBUDtBQUNELENBSEQ7O0FBS0EsSUFBTUosY0FBYyxFQUFDSyxVQUFELEVBQU9DLFVBQVAsRUFBYUMsY0FBYixFQUFxQkMsY0FBckIsRUFBNkJDLE1BQTdCLEVBQWlDQyxRQUFqQyxFQUFwQjs7QUFFQSxTQUFTTCxJQUFULENBQWNQLElBQWQsRUFBb0I7QUFDbEIsU0FB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QixLQUFLZ0IsT0FEVCxFQUNrQjtBQUNyQjBELFVBQU0xRSxLQUFLaUIsR0FEVTtBQUVyQlEsU0FBSztBQUNIa0QsWUFBTTNFLEtBQUt5QixHQURSO0FBRUhtRCxjQUFRLEtBRkw7QUFHSEMsc0JBQWdCLEtBSGI7QUFJSEMsa0JBQVk7QUFKVDtBQUZnQixHQURsQixFQVVKMUUsSUFWSSxDQVVDO0FBQUEsV0FBVztBQUNmWSxlQUFTVixPQUFPTSxHQUREO0FBRWZhLFdBQUtuQixPQUFPbUIsR0FBUCxDQUFXRCxRQUFYO0FBRlUsS0FBWDtBQUFBLEdBVkQsQ0FBUDtBQWNEIiwiZmlsZSI6InRyYW5zcGlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCBfc2FzcyA9IHJlcXVpcmUoJ25vZGUtc2FzcycpO1xuY29uc3QgX2xlc3MgPSByZXF1aXJlKCdsZXNzJyk7XG5jb25zdCBfc3R5bHVzID0gcmVxdWlyZSgnc3R5bHVzJyk7XG5jb25zdCBfY29mZmVlID0gcmVxdWlyZSgnY29mZmVlLXNjcmlwdCcpO1xuY29uc3QgYmFiZWwgPSByZXF1aXJlKCdiYWJlbC1jb3JlJyk7XG5jb25zdCB7cm9sbHVwfSA9IHJlcXVpcmUoJ3JvbGx1cCcpO1xuY29uc3Qgcm9sbHVwQmFiZWwgPSByZXF1aXJlKCdyb2xsdXAtcGx1Z2luLWJhYmVsJyk7XG5jb25zdCBwb3N0Y3NzID0gcmVxdWlyZSgncG9zdGNzcycpO1xuY29uc3QgY3NzbmV4dCA9IHJlcXVpcmUoJ3Bvc3Rjc3MtY3NzbmV4dCcpO1xuY29uc3QgY29uZmlnID0gcmVxdWlyZSgnLi4vY29uZmlnJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gdHJhbnNwaWxlKGZpbGUpIHtcbiAgY29uc3QgdHJhbnNwaWxlZCA9IHRyYW5zcGlsZXJzW2ZpbGUudHlwZV0oZmlsZSk7XG4gIHJldHVybiB0cmFuc3BpbGVkLnRoZW4ocmVzdWx0ID0+IF8uYXNzaWduKGZpbGUsIHJlc3VsdCkpO1xufTtcblxuY29uc3QgdHJhbnNwaWxlcnMgPSB7c2FzcywgbGVzcywgc3R5bHVzLCBjb2ZmZWUsIGpzLCBjc3N9O1xuXG5mdW5jdGlvbiBzYXNzKGZpbGUpIHtcbiAgcmV0dXJuIGJsdWViaXJkLnByb21pc2lmeShfc2Fzcy5yZW5kZXIpKHtcbiAgICBkYXRhOiBmaWxlLmNvbnRlbnQsXG4gICAgZmlsZTogZmlsZS5zcmMsXG4gICAgaW5jbHVkZVBhdGhzOiBbZmlsZS5kaXJdLFxuICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICBvdXRGaWxlOiBmaWxlLm5hbWUsXG4gICAgb21pdFNvdXJjZU1hcFVybDogdHJ1ZVxuICB9KVxuICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICBjb250ZW50OiByZXN1bHQuY3NzLnRvU3RyaW5nKCksXG4gICAgbWFwOiByZXN1bHQubWFwLnRvU3RyaW5nKCksXG4gICAgbWFwSW1wb3J0czogXy5tYXAocmVzdWx0LnN0YXRzLmluY2x1ZGVkRmlsZXMsIGluY2x1ZGVkID0+IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgaW5jbHVkZWQpKVxuICB9KSk7XG59XG5cbmZ1bmN0aW9uIGxlc3MoZmlsZSkge1xuICByZXR1cm4gX2xlc3MucmVuZGVyKGZpbGUuY29udGVudCwge1xuICAgIGZpbGVuYW1lOiBmaWxlLnNyYyxcbiAgICBzb3VyY2VNYXA6IHt9LFxuICAgIHBhdGhzOiBbZmlsZS5kaXJdXG4gIH0pXG4gIC50aGVuKHJlc3VsdCA9PiAoe1xuICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MudG9TdHJpbmcoKSxcbiAgICBtYXA6IHJlc3VsdC5tYXAsXG4gICAgbWFwSW1wb3J0czogcmVzdWx0LmltcG9ydHNcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBzdHlsdXMoZmlsZSkge1xuICBsZXQgcmVzdWx0O1xuICBjb25zdCBzdHlsZSA9IF9zdHlsdXMoZmlsZS5jb250ZW50KVxuICAgIC5zZXQoJ2ZpbGVuYW1lJywgZmlsZS5zcmMpXG4gICAgLnNldCgnc291cmNlbWFwJywge2NvbW1lbnQ6IGZhbHNlfSlcbiAgICAuZGVmaW5lKCd1cmwnLCBfc3R5bHVzLnJlc29sdmVyKCkpO1xuXG4gIHN0eWxlLnJlbmRlcigoZXJyLCBjc3MpID0+IHtcbiAgICByZXN1bHQgPSB7XG4gICAgICBjb250ZW50OiBjc3MsXG4gICAgICBtYXA6IHN0eWxlLnNvdXJjZW1hcCxcbiAgICAgIG1hcEltcG9ydHM6IHN0eWxlLmRlcHMoKVxuICAgIH07XG4gIH0pO1xuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gY29mZmVlKGZpbGUpIHtcbiAgY29uc3Qgb3B0cyA9IHtcbiAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgZmlsZW5hbWU6IGZpbGUuc3JjLFxuICAgIHNvdXJjZUZpbGVzOiBbZmlsZS5zcmNdXG4gIH07XG4gIGNvbnN0IGNvbXBpbGVkID0gX2NvZmZlZS5jb21waWxlKGZpbGUuY29udGVudCwgb3B0cyk7XG4gIGNvbnN0IHJlc3VsdCA9IHtcbiAgICBjb250ZW50OiBjb21waWxlZC5qcyxcbiAgICBtYXA6IGNvbXBpbGVkLnYzU291cmNlTWFwXG4gIH07XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbn1cblxuZnVuY3Rpb24ganMoZmlsZSkge1xuICAvLyBUT0RPOiB1bmhhY2sgYWxsIHRoZSBoYWNraW5nXG4gIGNvbnN0IGJhYmVsT3B0cyA9IHtcbiAgICBmaWxlbmFtZTogZmlsZS5iYXNlLFxuICAgIHByZXNldHM6IFtcbiAgICAgIFsnYmFiZWwtcHJlc2V0LWVzMjAxNSddLFxuICAgICAgJ2JhYmVsLXByZXNldC1lczIwMTYnLFxuICAgICAgJ2JhYmVsLXByZXNldC1lczIwMTcnLFxuICAgICAgJ2JhYmVsLXByZXNldC1yZWFjdCdcbiAgICBdLFxuICAgIHNvdXJjZU1hcHM6IHRydWUsXG4gICAgc291cmNlRmlsZU5hbWU6IGZpbGUuc3JjLFxuICAgIGFzdDogZmFsc2UsXG4gICAgY29tcGFjdDogZmFsc2VcbiAgfTtcblxuICBpZiAoY29uZmlnLm1vZHVsZXMpIHtcbiAgICBiYWJlbE9wdHMucHJlc2V0c1swXVsxXSA9IHttb2R1bGVzOiBmYWxzZX07XG4gICAgYmFiZWxPcHRzLnBsdWdpbnMgPSBbJ2JhYmVsLXBsdWdpbi1leHRlcm5hbC1oZWxwZXJzJ107XG5cbiAgICBjb25zdCByb2xsdXBPcHRzID0ge1xuICAgICAgZW50cnk6IGZpbGUuc3JjLFxuICAgICAgcGx1Z2luczogW1xuICAgICAgICByb2xsdXBCYWJlbChiYWJlbE9wdHMpXG4gICAgICBdXG4gICAgfTtcblxuICAgIHJldHVybiByb2xsdXAocm9sbHVwT3B0cylcbiAgICAgIC50aGVuKGJ1bmRsZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1bmRsZS5nZW5lcmF0ZSh7XG4gICAgICAgICAgZm9ybWF0OiBjb25maWcubW9kdWxlcyA9PT0gdHJ1ZSA/ICdlcycgOiBjb25maWcubW9kdWxlcyxcbiAgICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICAgICAgc291cmNlTWFwRmlsZTogY29uZmlnLnNyY0RpclxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb250ZW50OiByZXN1bHQuY29kZSxcbiAgICAgICAgICBtYXA6IHJlc3VsdC5tYXAsXG4gICAgICAgICAgbWFwSW1wb3J0czogcmVzdWx0Lm1hcC5zb3VyY2VzXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICAgLmNhdGNoKHJlc3VsdCA9PiB7Y29uc29sZS5sb2cocmVzdWx0KX0pO1xuICB9XG5cbiAgY29uc3QgdHJhbnNmb3JtZWQgPSBiYWJlbC50cmFuc2Zvcm0oZmlsZS5jb250ZW50LCBiYWJlbE9wdHMpO1xuICBjb25zdCByZXN1bHQgPSB7XG4gICAgY29udGVudDogdHJhbnNmb3JtZWQuY29kZSxcbiAgICBtYXA6IHRyYW5zZm9ybWVkLm1hcFxuICB9O1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGNzcyhmaWxlKSB7XG4gIHJldHVybiBwb3N0Y3NzKFtjc3NuZXh0XSlcbiAgICAucHJvY2VzcyhmaWxlLmNvbnRlbnQsIHtcbiAgICAgIGZyb206IGZpbGUuc3JjLFxuICAgICAgbWFwOiB7XG4gICAgICAgIHByZXY6IGZpbGUubWFwLFxuICAgICAgICBpbmxpbmU6IGZhbHNlLFxuICAgICAgICBzb3VyY2VzQ29udGVudDogZmFsc2UsXG4gICAgICAgIGFubm90YXRpb246IGZhbHNlXG4gICAgICB9XG4gICAgfSlcbiAgICAudGhlbihyZXN1bHQgPT4gKHtcbiAgICAgIGNvbnRlbnQ6IHJlc3VsdC5jc3MsXG4gICAgICBtYXA6IHJlc3VsdC5tYXAudG9TdHJpbmcoKVxuICAgIH0pKTtcbn1cbiJdfQ==
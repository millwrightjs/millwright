'use strict';

var path = require('path');
var bluebird = require('bluebird');
var fs = bluebird.promisifyAll(require('fs-extra'));
var _ = require('lodash');
var config = require('../config');
var util = require('../utils/util');

module.exports = function copySource(file) {
  var promises = [copyToSourcemaps(file.src)];

  if (file.map) {
    var parsedMap = _.isString(file.map) ? JSON.parse(file.map) : file.map;
    _.forEach(parsedMap.sources, function (source) {
      return promises.push(copyToSourcemaps(source));
    });
  }

  return Promise.all(promises).then(function () {
    return file;
  });

  function copyToSourcemaps(sourcePath) {
    var strippedSourcePath = util.stripIgnoredBasePath(sourcePath, config.assetIgnoredBasePaths);
    var sourcemapsPath = path.join(config.destDir, 'sourcemaps', strippedSourcePath);
    return _.attemptSilent(fs.copyAsync, sourcePath, sourcemapsPath, { dereference: true });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL2NvcHktc291cmNlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiYmx1ZWJpcmQiLCJmcyIsInByb21pc2lmeUFsbCIsIl8iLCJjb25maWciLCJ1dGlsIiwibW9kdWxlIiwiZXhwb3J0cyIsImNvcHlTb3VyY2UiLCJmaWxlIiwicHJvbWlzZXMiLCJjb3B5VG9Tb3VyY2VtYXBzIiwic3JjIiwibWFwIiwicGFyc2VkTWFwIiwiaXNTdHJpbmciLCJKU09OIiwicGFyc2UiLCJmb3JFYWNoIiwic291cmNlcyIsInB1c2giLCJzb3VyY2UiLCJQcm9taXNlIiwiYWxsIiwidGhlbiIsInNvdXJjZVBhdGgiLCJzdHJpcHBlZFNvdXJjZVBhdGgiLCJzdHJpcElnbm9yZWRCYXNlUGF0aCIsImFzc2V0SWdub3JlZEJhc2VQYXRocyIsInNvdXJjZW1hcHNQYXRoIiwiam9pbiIsImRlc3REaXIiLCJhdHRlbXB0U2lsZW50IiwiY29weUFzeW5jIiwiZGVyZWZlcmVuY2UiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNQyxXQUFXRCxRQUFRLFVBQVIsQ0FBakI7QUFDQSxJQUFNRSxLQUFLRCxTQUFTRSxZQUFULENBQXNCSCxRQUFRLFVBQVIsQ0FBdEIsQ0FBWDtBQUNBLElBQU1JLElBQUlKLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUssU0FBU0wsUUFBUSxXQUFSLENBQWY7QUFDQSxJQUFNTSxPQUFPTixRQUFRLGVBQVIsQ0FBYjs7QUFFQU8sT0FBT0MsT0FBUCxHQUFpQixTQUFTQyxVQUFULENBQW9CQyxJQUFwQixFQUEwQjtBQUN6QyxNQUFNQyxXQUFXLENBQUNDLGlCQUFpQkYsS0FBS0csR0FBdEIsQ0FBRCxDQUFqQjs7QUFFQSxNQUFJSCxLQUFLSSxHQUFULEVBQWM7QUFDWixRQUFNQyxZQUFZWCxFQUFFWSxRQUFGLENBQVdOLEtBQUtJLEdBQWhCLElBQXVCRyxLQUFLQyxLQUFMLENBQVdSLEtBQUtJLEdBQWhCLENBQXZCLEdBQThDSixLQUFLSSxHQUFyRTtBQUNBVixNQUFFZSxPQUFGLENBQVVKLFVBQVVLLE9BQXBCLEVBQTZCO0FBQUEsYUFBVVQsU0FBU1UsSUFBVCxDQUFjVCxpQkFBaUJVLE1BQWpCLENBQWQsQ0FBVjtBQUFBLEtBQTdCO0FBQ0Q7O0FBRUQsU0FBT0MsUUFBUUMsR0FBUixDQUFZYixRQUFaLEVBQXNCYyxJQUF0QixDQUEyQjtBQUFBLFdBQU1mLElBQU47QUFBQSxHQUEzQixDQUFQOztBQUVBLFdBQVNFLGdCQUFULENBQTBCYyxVQUExQixFQUFzQztBQUNwQyxRQUFNQyxxQkFBcUJyQixLQUFLc0Isb0JBQUwsQ0FBMEJGLFVBQTFCLEVBQXNDckIsT0FBT3dCLHFCQUE3QyxDQUEzQjtBQUNBLFFBQU1DLGlCQUFpQi9CLEtBQUtnQyxJQUFMLENBQVUxQixPQUFPMkIsT0FBakIsRUFBMEIsWUFBMUIsRUFBd0NMLGtCQUF4QyxDQUF2QjtBQUNBLFdBQU92QixFQUFFNkIsYUFBRixDQUFnQi9CLEdBQUdnQyxTQUFuQixFQUE4QlIsVUFBOUIsRUFBMENJLGNBQTFDLEVBQTBELEVBQUNLLGFBQWEsSUFBZCxFQUExRCxDQUFQO0FBQ0Q7QUFFRixDQWhCRCIsImZpbGUiOiJjb3B5LXNvdXJjZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCBmcyA9IGJsdWViaXJkLnByb21pc2lmeUFsbChyZXF1aXJlKCdmcy1leHRyYScpKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWwnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBjb3B5U291cmNlKGZpbGUpIHtcbiAgY29uc3QgcHJvbWlzZXMgPSBbY29weVRvU291cmNlbWFwcyhmaWxlLnNyYyldO1xuXG4gIGlmIChmaWxlLm1hcCkge1xuICAgIGNvbnN0IHBhcnNlZE1hcCA9IF8uaXNTdHJpbmcoZmlsZS5tYXApID8gSlNPTi5wYXJzZShmaWxlLm1hcCkgOiBmaWxlLm1hcDtcbiAgICBfLmZvckVhY2gocGFyc2VkTWFwLnNvdXJjZXMsIHNvdXJjZSA9PiBwcm9taXNlcy5wdXNoKGNvcHlUb1NvdXJjZW1hcHMoc291cmNlKSkpO1xuICB9XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IGZpbGUpO1xuXG4gIGZ1bmN0aW9uIGNvcHlUb1NvdXJjZW1hcHMoc291cmNlUGF0aCkge1xuICAgIGNvbnN0IHN0cmlwcGVkU291cmNlUGF0aCA9IHV0aWwuc3RyaXBJZ25vcmVkQmFzZVBhdGgoc291cmNlUGF0aCwgY29uZmlnLmFzc2V0SWdub3JlZEJhc2VQYXRocyk7XG4gICAgY29uc3Qgc291cmNlbWFwc1BhdGggPSBwYXRoLmpvaW4oY29uZmlnLmRlc3REaXIsICdzb3VyY2VtYXBzJywgc3RyaXBwZWRTb3VyY2VQYXRoKTtcbiAgICByZXR1cm4gXy5hdHRlbXB0U2lsZW50KGZzLmNvcHlBc3luYywgc291cmNlUGF0aCwgc291cmNlbWFwc1BhdGgsIHtkZXJlZmVyZW5jZTogdHJ1ZX0pO1xuICB9XG5cbn1cbiJdfQ==
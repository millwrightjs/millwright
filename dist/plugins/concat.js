'use strict';

var config = require('../config');
var util = require('../utils/util');
var path = require('path');
var _ = require('lodash');
var Concat = require('concat-with-sourcemaps');

module.exports = function concat(assets) {
  var webPaths = _(assets).map('webPath').uniq().value();

  return _.reduce(webPaths, function (acc, webPath) {
    var group = _.filter(assets, { webPath: webPath });
    return _.concat(acc, concatenate(group));
  }, []);

  function concatenate(group) {
    var result = _.pick(group[0], ['dirDest', 'filenameDest', 'groupKey', 'typeDest', 'filenameDest', 'dest', 'webPath', 'sourcemapPath']);

    var c = new Concat(true, result.dest, '\n');
    _.forEach(group, function (asset) {
      var mappedPath = util.stripIgnoredBasePath(asset.src, config.assetIgnoredBasePaths);
      c.add(mappedPath, asset.content, asset.map);
    });

    result.content = c.content.toString();
    result.map = c.sourceMap;

    return result;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL2NvbmNhdC5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJyZXF1aXJlIiwidXRpbCIsInBhdGgiLCJfIiwiQ29uY2F0IiwibW9kdWxlIiwiZXhwb3J0cyIsImNvbmNhdCIsImFzc2V0cyIsIndlYlBhdGhzIiwibWFwIiwidW5pcSIsInZhbHVlIiwicmVkdWNlIiwiYWNjIiwid2ViUGF0aCIsImdyb3VwIiwiZmlsdGVyIiwiY29uY2F0ZW5hdGUiLCJyZXN1bHQiLCJwaWNrIiwiYyIsImRlc3QiLCJmb3JFYWNoIiwibWFwcGVkUGF0aCIsInN0cmlwSWdub3JlZEJhc2VQYXRoIiwiYXNzZXQiLCJzcmMiLCJhc3NldElnbm9yZWRCYXNlUGF0aHMiLCJhZGQiLCJjb250ZW50IiwidG9TdHJpbmciLCJzb3VyY2VNYXAiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsU0FBU0MsUUFBUSxXQUFSLENBQWY7QUFDQSxJQUFNQyxPQUFPRCxRQUFRLGVBQVIsQ0FBYjtBQUNBLElBQU1FLE9BQU9GLFFBQVEsTUFBUixDQUFiO0FBQ0EsSUFBTUcsSUFBSUgsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNSSxTQUFTSixRQUFRLHdCQUFSLENBQWY7O0FBRUFLLE9BQU9DLE9BQVAsR0FBaUIsU0FBU0MsTUFBVCxDQUFnQkMsTUFBaEIsRUFBd0I7QUFDdkMsTUFBTUMsV0FBV04sRUFBRUssTUFBRixFQUFVRSxHQUFWLENBQWMsU0FBZCxFQUF5QkMsSUFBekIsR0FBZ0NDLEtBQWhDLEVBQWpCOztBQUVBLFNBQU9ULEVBQUVVLE1BQUYsQ0FBU0osUUFBVCxFQUFtQixVQUFDSyxHQUFELEVBQU1DLE9BQU4sRUFBa0I7QUFDMUMsUUFBTUMsUUFBUWIsRUFBRWMsTUFBRixDQUFTVCxNQUFULEVBQWlCLEVBQUNPLGdCQUFELEVBQWpCLENBQWQ7QUFDQSxXQUFPWixFQUFFSSxNQUFGLENBQVNPLEdBQVQsRUFBY0ksWUFBWUYsS0FBWixDQUFkLENBQVA7QUFDRCxHQUhNLEVBR0osRUFISSxDQUFQOztBQUtBLFdBQVNFLFdBQVQsQ0FBcUJGLEtBQXJCLEVBQTRCO0FBQzFCLFFBQU1HLFNBQVNoQixFQUFFaUIsSUFBRixDQUFPSixNQUFNLENBQU4sQ0FBUCxFQUNiLENBQUMsU0FBRCxFQUFZLGNBQVosRUFBNEIsVUFBNUIsRUFBd0MsVUFBeEMsRUFBb0QsY0FBcEQsRUFBb0UsTUFBcEUsRUFBNEUsU0FBNUUsRUFBdUYsZUFBdkYsQ0FEYSxDQUFmOztBQUdBLFFBQU1LLElBQUksSUFBSWpCLE1BQUosQ0FBVyxJQUFYLEVBQWlCZSxPQUFPRyxJQUF4QixFQUE4QixJQUE5QixDQUFWO0FBQ0FuQixNQUFFb0IsT0FBRixDQUFVUCxLQUFWLEVBQWlCLGlCQUFTO0FBQ3hCLFVBQU1RLGFBQWF2QixLQUFLd0Isb0JBQUwsQ0FBMEJDLE1BQU1DLEdBQWhDLEVBQXFDNUIsT0FBTzZCLHFCQUE1QyxDQUFuQjtBQUNBUCxRQUFFUSxHQUFGLENBQU1MLFVBQU4sRUFBa0JFLE1BQU1JLE9BQXhCLEVBQWlDSixNQUFNaEIsR0FBdkM7QUFDRCxLQUhEOztBQUtBUyxXQUFPVyxPQUFQLEdBQWlCVCxFQUFFUyxPQUFGLENBQVVDLFFBQVYsRUFBakI7QUFDQVosV0FBT1QsR0FBUCxHQUFhVyxFQUFFVyxTQUFmOztBQUVBLFdBQU9iLE1BQVA7QUFDRDtBQUNGLENBdkJEIiwiZmlsZSI6ImNvbmNhdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWwnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBDb25jYXQgPSByZXF1aXJlKCdjb25jYXQtd2l0aC1zb3VyY2VtYXBzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gY29uY2F0KGFzc2V0cykge1xuICBjb25zdCB3ZWJQYXRocyA9IF8oYXNzZXRzKS5tYXAoJ3dlYlBhdGgnKS51bmlxKCkudmFsdWUoKTtcblxuICByZXR1cm4gXy5yZWR1Y2Uod2ViUGF0aHMsIChhY2MsIHdlYlBhdGgpID0+IHtcbiAgICBjb25zdCBncm91cCA9IF8uZmlsdGVyKGFzc2V0cywge3dlYlBhdGh9KTtcbiAgICByZXR1cm4gXy5jb25jYXQoYWNjLCBjb25jYXRlbmF0ZShncm91cCkpO1xuICB9LCBbXSk7XG5cbiAgZnVuY3Rpb24gY29uY2F0ZW5hdGUoZ3JvdXApIHtcbiAgICBjb25zdCByZXN1bHQgPSBfLnBpY2soZ3JvdXBbMF0sXG4gICAgICBbJ2RpckRlc3QnLCAnZmlsZW5hbWVEZXN0JywgJ2dyb3VwS2V5JywgJ3R5cGVEZXN0JywgJ2ZpbGVuYW1lRGVzdCcsICdkZXN0JywgJ3dlYlBhdGgnLCAnc291cmNlbWFwUGF0aCddKTtcblxuICAgIGNvbnN0IGMgPSBuZXcgQ29uY2F0KHRydWUsIHJlc3VsdC5kZXN0LCAnXFxuJyk7XG4gICAgXy5mb3JFYWNoKGdyb3VwLCBhc3NldCA9PiB7XG4gICAgICBjb25zdCBtYXBwZWRQYXRoID0gdXRpbC5zdHJpcElnbm9yZWRCYXNlUGF0aChhc3NldC5zcmMsIGNvbmZpZy5hc3NldElnbm9yZWRCYXNlUGF0aHMpO1xuICAgICAgYy5hZGQobWFwcGVkUGF0aCwgYXNzZXQuY29udGVudCwgYXNzZXQubWFwKTtcbiAgICB9KTtcblxuICAgIHJlc3VsdC5jb250ZW50ID0gYy5jb250ZW50LnRvU3RyaW5nKCk7XG4gICAgcmVzdWx0Lm1hcCA9IGMuc291cmNlTWFwO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19
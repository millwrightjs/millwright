'use strict';

var _ = require('lodash');
var fs = require('fs-extra');
var path = require('path');
var config = require('../config');
var mustache = require('mustache');
var decache = require('decache');

var _require = require('../utils/util'),
    changeExt = _require.changeExt;

var cache = require('../utils/cache');

module.exports = staticGen;

var partials = void 0,
    lambdas = void 0;

function staticGen(file, opts) {
  opts = _.isObject(opts) ? opts : {};
  mustache.tags = config.templateTags;
  partials = !partials || opts.shouldGetPartials ? getPartials() : partials;
  lambdas = !lambdas || opts.shouldGetLambdas ? getLambdas(opts.shouldGetLambdas) : lambdas;

  var src = file.src,
      dataPath = file.data,
      wrapperDataPath = file.wrapperData;

  var wrapper = _.has(file, 'wrapper') ? fs.readFileSync(file.wrapper, 'utf8') : '';
  var page = fs.readFileSync(src, 'utf8');

  var dataRef = cache.get('files', dataPath);
  var data = _.get(dataRef, 'content');
  var wrapperDataRef = cache.get('files', wrapperDataPath);
  var wrapperData = _.get(wrapperDataRef, 'content');
  var templateData = _.assign({}, wrapperData, data, { lambdas: lambdas });

  if (_.has(wrapperData, 'assets') && _.has(data, 'assets')) {
    templateData.assets = _.mergeWith({}, wrapperData.assets, data.assets, function (dest, src) {
      return [dest, src].every(_.isArray) ? _.union(dest, src) : undefined;
    });
  }

  var pagePartials = wrapper ? _.assign({}, partials, { page: page }) : partials;
  var result = mustache.render(wrapper || page, templateData, pagePartials);

  fs.outputFileSync(file.dest, result);

  if (data) {
    cache.push('deps', {
      src: dataRef.src,
      srcResolved: dataRef.srcResolved,
      consumer: file.srcResolved
    });
  }

  if (wrapperData) {
    cache.push('deps', {
      src: wrapperDataRef.src,
      srcResolved: wrapperDataRef.srcResolved,
      consumer: file.srcResolved
    });
  }

  if (wrapper) {
    var wrapperRef = cache.get('files', file.wrapper);
    cache.push('deps', {
      src: wrapperRef.src,
      srcResolved: wrapperRef.srcResolved,
      consumer: file.srcResolved
    });
  }
}

function getPartials() {
  var partialFileNames = _.attemptSilent(fs.readdirSync, config.partialsDir);
  return _.reduce(partialFileNames, function (obj, partialFileName) {
    var name = path.basename(partialFileName, '.mustache');
    var partialPath = path.join(config.partialsDir, partialFileName);
    obj[name] = fs.readFileSync(partialPath).toString();
    return obj;
  }, {});
}

function getLambdas(reload) {
  var lambdaFileNames = _.attemptSilent(fs.readdirSync, config.lambdasDir);
  return _.reduce(lambdaFileNames, function (obj, lambdaFileName) {
    var name = path.basename(lambdaFileName, '.js');
    var modulePath = path.join(process.cwd(), config.lambdasDir, name);
    var mod = require(modulePath).module;

    if (reload) {
      decache(modulePath);
    }

    obj[name] = function () {
      return mod.require(modulePath).lambda;
    };
    return obj;
  }, {});
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL3N0YXRpYy5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImZzIiwicGF0aCIsImNvbmZpZyIsIm11c3RhY2hlIiwiZGVjYWNoZSIsImNoYW5nZUV4dCIsImNhY2hlIiwibW9kdWxlIiwiZXhwb3J0cyIsInN0YXRpY0dlbiIsInBhcnRpYWxzIiwibGFtYmRhcyIsImZpbGUiLCJvcHRzIiwiaXNPYmplY3QiLCJ0YWdzIiwidGVtcGxhdGVUYWdzIiwic2hvdWxkR2V0UGFydGlhbHMiLCJnZXRQYXJ0aWFscyIsInNob3VsZEdldExhbWJkYXMiLCJnZXRMYW1iZGFzIiwic3JjIiwiZGF0YVBhdGgiLCJkYXRhIiwid3JhcHBlckRhdGFQYXRoIiwid3JhcHBlckRhdGEiLCJ3cmFwcGVyIiwiaGFzIiwicmVhZEZpbGVTeW5jIiwicGFnZSIsImRhdGFSZWYiLCJnZXQiLCJ3cmFwcGVyRGF0YVJlZiIsInRlbXBsYXRlRGF0YSIsImFzc2lnbiIsImFzc2V0cyIsIm1lcmdlV2l0aCIsImRlc3QiLCJldmVyeSIsImlzQXJyYXkiLCJ1bmlvbiIsInVuZGVmaW5lZCIsInBhZ2VQYXJ0aWFscyIsInJlc3VsdCIsInJlbmRlciIsIm91dHB1dEZpbGVTeW5jIiwicHVzaCIsInNyY1Jlc29sdmVkIiwiY29uc3VtZXIiLCJ3cmFwcGVyUmVmIiwicGFydGlhbEZpbGVOYW1lcyIsImF0dGVtcHRTaWxlbnQiLCJyZWFkZGlyU3luYyIsInBhcnRpYWxzRGlyIiwicmVkdWNlIiwib2JqIiwicGFydGlhbEZpbGVOYW1lIiwibmFtZSIsImJhc2VuYW1lIiwicGFydGlhbFBhdGgiLCJqb2luIiwidG9TdHJpbmciLCJyZWxvYWQiLCJsYW1iZGFGaWxlTmFtZXMiLCJsYW1iZGFzRGlyIiwibGFtYmRhRmlsZU5hbWUiLCJtb2R1bGVQYXRoIiwicHJvY2VzcyIsImN3ZCIsIm1vZCIsImxhbWJkYSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxJQUFJQyxRQUFR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SUFBWXpELEdBQUc0QixZQUFILENBQWdCK0IsV0FBaEIsRUFBNkJFLFFBQTdCLEVBQVo7QUFDQSxXQUFPTixHQUFQO0FBQ0QsR0FMTSxFQUtKLEVBTEksQ0FBUDtBQU1EOztBQUVELFNBQVNuQyxVQUFULENBQW9CMEMsTUFBcEIsRUFBNEI7QUFDMUIsTUFBTUMsa0JBQWtCakUsRUFBRXFELGFBQUYsQ0FBZ0JuRCxHQUFHb0QsV0FBbkIsRUFBZ0NsRCxPQUFPOEQsVUFBdkMsQ0FBeEI7QUFDQSxTQUFPbEUsRUFBRXdELE1BQUYsQ0FBU1MsZUFBVCxFQUEwQixVQUFDUixHQUFELEVBQU1VLGNBQU4sRUFBeUI7QUFDeEQsUUFBTVIsT0FBT3hELEtBQUt5RCxRQUFMLENBQWNPLGNBQWQsRUFBOEIsS0FBOUIsQ0FBYjtBQUNBLFFBQU1DLGFBQWFqRSxLQUFLMkQsSUFBTCxDQUFVTyxRQUFRQyxHQUFSLEVBQVYsRUFBeUJsRSxPQUFPOEQsVUFBaEMsRUFBNENQLElBQTVDLENBQW5CO0FBQ0EsUUFBTVksTUFBTXRFLFFBQVFtRSxVQUFSLEVBQW9CM0QsTUFBaEM7O0FBRUEsUUFBSXVELE1BQUosRUFBWTtBQUNWMUQsY0FBUThELFVBQVI7QUFDRDs7QUFFRFgsUUFBSUUsSUFBSixJQUFZO0FBQUEsYUFBTVksSUFBSXRFLE9BQUosQ0FBWW1FLFVBQVosRUFBd0JJLE1BQTlCO0FBQUEsS0FBWjtBQUNBLFdBQU9mLEdBQVA7QUFDRCxHQVhNLEVBV0osRUFYSSxDQUFQO0FBWUQiLCJmaWxlIjoic3RhdGljLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuY29uc3QgbXVzdGFjaGUgPSByZXF1aXJlKCdtdXN0YWNoZScpO1xuY29uc3QgZGVjYWNoZSA9IHJlcXVpcmUoJ2RlY2FjaGUnKTtcbmNvbnN0IHtjaGFuZ2VFeHR9ID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbCcpO1xuY29uc3QgY2FjaGUgPSByZXF1aXJlKCcuLi91dGlscy9jYWNoZScpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHN0YXRpY0dlbjtcblxubGV0IHBhcnRpYWxzLCBsYW1iZGFzO1xuXG5mdW5jdGlvbiBzdGF0aWNHZW4oZmlsZSwgb3B0cykge1xuICBvcHRzID0gXy5pc09iamVjdChvcHRzKSA/IG9wdHMgOiB7fTtcbiAgbXVzdGFjaGUudGFncyA9IGNvbmZpZy50ZW1wbGF0ZVRhZ3M7XG4gIHBhcnRpYWxzID0gKCFwYXJ0aWFscyB8fCBvcHRzLnNob3VsZEdldFBhcnRpYWxzKSA/IGdldFBhcnRpYWxzKCkgOiBwYXJ0aWFscztcbiAgbGFtYmRhcyA9ICghbGFtYmRhcyB8fCBvcHRzLnNob3VsZEdldExhbWJkYXMpID8gZ2V0TGFtYmRhcyhvcHRzLnNob3VsZEdldExhbWJkYXMpIDogbGFtYmRhcztcblxuICBjb25zdCB7c3JjLCBkYXRhOiBkYXRhUGF0aCwgd3JhcHBlckRhdGE6IHdyYXBwZXJEYXRhUGF0aH0gPSBmaWxlO1xuICBjb25zdCB3cmFwcGVyID0gXy5oYXMoZmlsZSwgJ3dyYXBwZXInKSA/IGZzLnJlYWRGaWxlU3luYyhmaWxlLndyYXBwZXIsICd1dGY4JykgOiAnJztcbiAgY29uc3QgcGFnZSA9IGZzLnJlYWRGaWxlU3luYyhzcmMsICd1dGY4Jyk7XG5cbiAgY29uc3QgZGF0YVJlZiA9IGNhY2hlLmdldCgnZmlsZXMnLCBkYXRhUGF0aCk7XG4gIGNvbnN0IGRhdGEgPSBfLmdldChkYXRhUmVmLCAnY29udGVudCcpO1xuICBjb25zdCB3cmFwcGVyRGF0YVJlZiA9IGNhY2hlLmdldCgnZmlsZXMnLCB3cmFwcGVyRGF0YVBhdGgpO1xuICBjb25zdCB3cmFwcGVyRGF0YSA9IF8uZ2V0KHdyYXBwZXJEYXRhUmVmLCAnY29udGVudCcpO1xuICBjb25zdCB0ZW1wbGF0ZURhdGEgPSBfLmFzc2lnbih7fSwgd3JhcHBlckRhdGEsIGRhdGEsIHtsYW1iZGFzfSk7XG5cbiAgaWYgKF8uaGFzKHdyYXBwZXJEYXRhLCAnYXNzZXRzJykgJiYgXy5oYXMoZGF0YSwgJ2Fzc2V0cycpKSB7XG4gICAgdGVtcGxhdGVEYXRhLmFzc2V0cyA9IF8ubWVyZ2VXaXRoKHt9LCB3cmFwcGVyRGF0YS5hc3NldHMsIGRhdGEuYXNzZXRzLCAoZGVzdCwgc3JjKSA9PiB7XG4gICAgICByZXR1cm4gW2Rlc3QsIHNyY10uZXZlcnkoXy5pc0FycmF5KSA/IF8udW5pb24oZGVzdCwgc3JjKSA6IHVuZGVmaW5lZDtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHBhZ2VQYXJ0aWFscyA9IHdyYXBwZXIgPyBfLmFzc2lnbih7fSwgcGFydGlhbHMsIHtwYWdlfSkgOiBwYXJ0aWFscztcbiAgY29uc3QgcmVzdWx0ID0gbXVzdGFjaGUucmVuZGVyKHdyYXBwZXIgfHwgcGFnZSwgdGVtcGxhdGVEYXRhLCBwYWdlUGFydGlhbHMpO1xuXG4gIGZzLm91dHB1dEZpbGVTeW5jKGZpbGUuZGVzdCwgcmVzdWx0KTtcblxuICBpZiAoZGF0YSkge1xuICAgIGNhY2hlLnB1c2goJ2RlcHMnLCB7XG4gICAgICBzcmM6IGRhdGFSZWYuc3JjLFxuICAgICAgc3JjUmVzb2x2ZWQ6IGRhdGFSZWYuc3JjUmVzb2x2ZWQsXG4gICAgICBjb25zdW1lcjogZmlsZS5zcmNSZXNvbHZlZFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKHdyYXBwZXJEYXRhKSB7XG4gICAgY2FjaGUucHVzaCgnZGVwcycsIHtcbiAgICAgIHNyYzogd3JhcHBlckRhdGFSZWYuc3JjLFxuICAgICAgc3JjUmVzb2x2ZWQ6IHdyYXBwZXJEYXRhUmVmLnNyY1Jlc29sdmVkLFxuICAgICAgY29uc3VtZXI6IGZpbGUuc3JjUmVzb2x2ZWRcbiAgICB9KTtcbiAgfVxuXG4gIGlmICh3cmFwcGVyKSB7XG4gICAgY29uc3Qgd3JhcHBlclJlZiA9IGNhY2hlLmdldCgnZmlsZXMnLCBmaWxlLndyYXBwZXIpO1xuICAgIGNhY2hlLnB1c2goJ2RlcHMnLCB7XG4gICAgICBzcmM6IHdyYXBwZXJSZWYuc3JjLFxuICAgICAgc3JjUmVzb2x2ZWQ6IHdyYXBwZXJSZWYuc3JjUmVzb2x2ZWQsXG4gICAgICBjb25zdW1lcjogZmlsZS5zcmNSZXNvbHZlZFxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBhcnRpYWxzKCkge1xuICBjb25zdCBwYXJ0aWFsRmlsZU5hbWVzID0gXy5hdHRlbXB0U2lsZW50KGZzLnJlYWRkaXJTeW5jLCBjb25maWcucGFydGlhbHNEaXIpO1xuICByZXR1cm4gXy5yZWR1Y2UocGFydGlhbEZpbGVOYW1lcywgKG9iaiwgcGFydGlhbEZpbGVOYW1lKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHBhdGguYmFzZW5hbWUocGFydGlhbEZpbGVOYW1lLCAnLm11c3RhY2hlJyk7XG4gICAgY29uc3QgcGFydGlhbFBhdGggPSBwYXRoLmpvaW4oY29uZmlnLnBhcnRpYWxzRGlyLCBwYXJ0aWFsRmlsZU5hbWUpO1xuICAgIG9ialtuYW1lXSA9IGZzLnJlYWRGaWxlU3luYyhwYXJ0aWFsUGF0aCkudG9TdHJpbmcoKTtcbiAgICByZXR1cm4gb2JqO1xuICB9LCB7fSk7XG59XG5cbmZ1bmN0aW9uIGdldExhbWJkYXMocmVsb2FkKSB7XG4gIGNvbnN0IGxhbWJkYUZpbGVOYW1lcyA9IF8uYXR0ZW1wdFNpbGVudChmcy5yZWFkZGlyU3luYywgY29uZmlnLmxhbWJkYXNEaXIpO1xuICByZXR1cm4gXy5yZWR1Y2UobGFtYmRhRmlsZU5hbWVzLCAob2JqLCBsYW1iZGFGaWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBwYXRoLmJhc2VuYW1lKGxhbWJkYUZpbGVOYW1lLCAnLmpzJyk7XG4gICAgY29uc3QgbW9kdWxlUGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBjb25maWcubGFtYmRhc0RpciwgbmFtZSk7XG4gICAgY29uc3QgbW9kID0gcmVxdWlyZShtb2R1bGVQYXRoKS5tb2R1bGU7XG5cbiAgICBpZiAocmVsb2FkKSB7XG4gICAgICBkZWNhY2hlKG1vZHVsZVBhdGgpO1xuICAgIH1cblxuICAgIG9ialtuYW1lXSA9ICgpID0+IG1vZC5yZXF1aXJlKG1vZHVsZVBhdGgpLmxhbWJkYTtcbiAgICByZXR1cm4gb2JqO1xuICB9LCB7fSk7XG59XG4iXX0=